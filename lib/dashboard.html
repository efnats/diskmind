<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>diskmind</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='1.8' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cpath d='M12 5a7 7 0 0 1 7 7'/%3E%3Cpath d='M12 19a7 7 0 0 1-7-7'/%3E%3Ccircle cx='12' cy='12' r='3.5'/%3E%3Ccircle cx='12' cy='12' r='1.2' fill='%233b82f6' stroke='none'/%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc; --bg-card: #ffffff; --bg-hover: #f1f5f9;
            --text-primary: #0f172a; --text-secondary: #475569; --text-muted: #94a3b8;
            --border: #e2e8f0; --accent: #3b82f6;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        }
        [data-theme="dark"] {
            --bg-primary: #0f172a; --bg-card: #1e293b; --bg-hover: #334155;
            --text-primary: #f1f5f9; --text-secondary: #cbd5e1; --text-muted: #64748b;
            --border: #334155;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .header h1 { font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .header h1 .logo-icon { color: var(--accent); flex-shrink: 0; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .timestamp { font-size: 13px; color: var(--text-muted); }
        .btn { background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 13px; color: var(--text-secondary); transition: all 0.15s; }
        .icon-btn { padding: 6px 8px; display: inline-flex; align-items: center; justify-content: center; }
        .btn:hover { background: var(--border); }
        .btn.primary { background: var(--accent); color: white; border-color: var(--accent); }
        .btn.primary:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px 20px; border-left: 4px solid var(--accent); cursor: pointer; transition: all 0.15s; }
        .stat:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .stat.active { box-shadow: 0 0 0 2px var(--accent); }
        .stat.critical { border-left-color: var(--danger); }
        .stat.warning { border-left-color: var(--warning); }
        .stat.healthy { border-left-color: var(--success); }
        .stat-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
        .stat-value { font-size: 28px; font-weight: 700; }
        .stat.critical .stat-value { color: var(--danger); }
        .stat.warning .stat-value { color: var(--warning); }
        .stat-sub { font-size: 12px; color: var(--text-muted); }
        
        .filters { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; margin-bottom: 24px; display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap; }
        .delta-range { display: flex; align-items: center; gap: 4px; }
        .delta-range .delta-label { font-size: 13px; color: var(--text-secondary); padding: 0 2px; }
        .delta-range input[type="number"] { width: 50px; padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 13px; text-align: center; }
        .delta-range select { padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 13px; }
        .filter-separator { width: 1px; height: 24px; background: var(--border); margin: 0 12px; align-self: flex-end; margin-bottom: 6px; }
        .filter-group { display: flex; align-items: center; gap: 4px; }
        .filter-group-labeled { display: flex; flex-direction: column; gap: 4px; }
        .filter-group-label { font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); }
        .info-icon { cursor: help; opacity: 0.6; font-size: 11px; position: relative; }
        .info-icon:hover { opacity: 1; }
        .info-icon:hover::after { content: attr(data-tip); position: absolute; left: 50%; transform: translateX(-50%); top: 18px; background: var(--bg-primary); color: var(--text-secondary); border: 1px solid var(--border); padding: 10px 14px; border-radius: 6px; font-size: 12px; font-weight: 400; text-transform: none; letter-spacing: normal; width: max-content; max-width: 260px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15); line-height: 1.5; pointer-events: none; }
        .filter-group-controls { display: flex; align-items: center; gap: 6px; }
        .filter-group-controls > select, #deltaRange { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 13px; }
        .filter-group-controls > input:not(.search-input) { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 13px; width: 140px; }
        .filter-group-end { margin-left: auto; }
        .search-input { padding: 6px 10px; border: 1px solid #d5d9e0; border-radius: 6px; background: transparent; color: var(--text-primary); font-size: 13px; width: 160px; outline: none; transition: all 0.15s; }
        .search-input::placeholder { color: var(--text-muted); }
        .search-input:hover { border-color: #b0b7c3; }
        .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59,130,246,0.12); }
        [data-theme="dark"] .search-input { border-color: #2a3a52; background: transparent; }
        [data-theme="dark"] .search-input:hover { border-color: #3d5a80; }
        [data-theme="dark"] .search-input:focus { border-color: #3b82f6; }
        
        /* Custom Dropdown */
        .custom-select { position: relative; min-width: 120px; }
        .custom-select-trigger { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 13px; cursor: pointer; transition: all 0.15s; user-select: none; }
        .custom-select-trigger:hover { border-color: var(--text-muted); }
        .custom-select.open .custom-select-trigger { border-color: var(--accent); }
        .custom-select-arrow { color: var(--text-muted); transition: transform 0.2s; flex-shrink: 0; }
        .custom-select.open .custom-select-arrow { transform: rotate(180deg); }
        .custom-select-options { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; opacity: 0; visibility: hidden; transform: translateY(-8px); transition: all 0.15s ease; max-height: 240px; overflow-y: auto; }
        .custom-select.open .custom-select-options { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-select-option { padding: 8px 12px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.1s; }
        .custom-select-option:hover { background: var(--bg-hover); }
        .custom-select-option.selected { color: var(--accent); }
        .custom-select-option.selected::before { content: '✓'; font-size: 11px; }
        .custom-select-option:not(.selected)::before { content: ''; width: 11px; }
        .custom-select-option:first-child { border-radius: 5px 5px 0 0; }
        .custom-select-option:last-child { border-radius: 0 0 5px 5px; }
        
        .edit-thresholds-btn { width: 32px; height: 32px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-primary); color: var(--text-secondary); cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
        .edit-thresholds-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .host-toolbar-btn { width: 32px; height: 32px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-primary); color: var(--text-secondary); cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .host-toolbar-btn:hover { background: var(--bg-secondary); color: var(--text-primary); border-color: var(--text-muted); }
        .host-toolbar-btn.spinning { animation: spin 1s linear infinite; pointer-events: none; }
        .add-host-inline { display: flex; align-items: center; }
        .add-host-input-group { display: flex; align-items: center; gap: 4px; }
        .add-host-input { padding: 6px 10px; border: 1px solid var(--accent); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 12px; width: 130px; font-family: 'SF Mono', 'Consolas', monospace; }
        .add-host-input.add-host-user { width: 70px; }
        .add-host-input.add-host-port { width: 50px; text-align: center; }
        .add-host-at { color: var(--text-muted); font-size: 12px; font-family: 'SF Mono', 'Consolas', monospace; }
        .add-host-input:focus { outline: none; }
        .add-host-confirm { padding: 6px 8px; border: none; border-radius: 6px; background: var(--success); color: white; font-size: 12px; cursor: pointer; }
        .add-host-confirm:hover { opacity: 0.9; }
        .add-host-cancel { padding: 6px 8px; border: none; border-radius: 6px; background: var(--bg-secondary); color: var(--text-muted); font-size: 12px; cursor: pointer; }
        .add-host-cancel:hover { background: var(--bg-hover); color: var(--text-primary); }
        select, input[type="text"] { padding: 7px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: var(--bg-primary); color: var(--text-primary); }
        .checkbox-label { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-secondary); cursor: pointer; }
        
        .host-group { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; overflow: hidden; }
        .host-header { padding: 12px 16px; background: var(--bg-hover); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .host-name { font-size: 13px; font-weight: 600; }
        .host-name-display { font-size: 13px; font-weight: 600; }
        .host-method-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 2px 5px; border-radius: 3px; margin-right: 6px; vertical-align: 1px; }
        .host-method-badge.ssh { background: rgba(59,130,246,0.15); color: var(--accent); }
        .host-method-badge.push { background: rgba(16,185,129,0.15); color: var(--success); }
        .push-hint { margin-left: 8px; cursor: help; font-size: 13px; color: var(--warning); position: relative; }
        .push-hint:hover::after { content: attr(data-tip); position: absolute; left: 50%; transform: translateX(-50%); top: 22px; background: var(--bg-primary); color: var(--text-secondary); border: 1px solid var(--border); padding: 10px 14px; border-radius: 6px; font-size: 12px; font-weight: 400; width: max-content; max-width: 280px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15); line-height: 1.5; pointer-events: none; }
        .host-user { font-size: 12px; font-weight: 400; color: var(--text-muted); }
        .host-edit-form { display: inline-flex; align-items: center; gap: 4px; }
        .method-toggle { display: inline-flex; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; height: 26px; }
        .method-toggle-btn { padding: 0 8px; border: none; background: transparent; color: var(--text-muted); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s; }
        .method-toggle-btn.active { background: var(--accent); color: white; }
        .method-toggle-btn:not(.active):hover { background: var(--bg-hover); color: var(--text-primary); }
        .host-edit-input { padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 12px; font-family: 'SF Mono', 'Consolas', monospace; }
        .host-edit-input:focus { outline: none; border-color: var(--accent); }
        .host-edit-input.host-edit-user { width: 60px; }
        .host-edit-input.host-edit-ip { width: 120px; }
        .host-edit-input.host-edit-port { width: 45px; text-align: center; }
        .host-edit-at { color: var(--text-muted); font-size: 12px; }
        .host-edit-ssh-fields { display: inline-flex; align-items: center; gap: 4px; }
        .host-edit-confirm { padding: 4px 8px; border: none; border-radius: 4px; background: var(--success); color: white; font-size: 12px; cursor: pointer; }
        .host-edit-confirm:hover { opacity: 0.9; }
        .host-edit-cancel { padding: 4px 8px; border: none; border-radius: 4px; background: var(--bg-secondary); color: var(--text-muted); font-size: 12px; cursor: pointer; }
        .host-edit-cancel:hover { background: var(--bg-hover); color: var(--text-primary); }
        .host-badge { font-size: 11px; padding: 2px 8px; border-radius: 12px; font-weight: 500; margin-left: 12px; }
        .host-badge.ok { background: rgba(16,185,129,0.1); color: var(--success); }
        .host-badge.warning { background: rgba(245,158,11,0.1); color: var(--warning); }
        .host-badge.critical { background: rgba(239,68,68,0.1); color: var(--danger); }
        .host-badge.offline { background: rgba(239,68,68,0.1); color: var(--danger); }
        .host-badge.pending { background: rgba(59,130,246,0.1); color: var(--accent); }
        .host-group.host-error { }
        .host-group.host-error .host-header { cursor: default; border-left: 3px solid var(--danger); }
        .host-group.host-error .host-name { color: var(--text-secondary); }
        .host-group.host-error .host-stats { color: var(--text-secondary); }
        .pending-hosts-section { margin-top: 16px; border: 1px dashed var(--border); border-radius: 10px; padding: 16px; }
        .pending-hosts-header { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 12px; }
        .pending-host-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; }
        .pending-host-row + .pending-host-row { border-top: 1px solid var(--border); }
        .pending-host-info { display: flex; align-items: center; gap: 8px; }
        .pending-host-ip { font-family: 'SF Mono', 'Consolas', monospace; font-size: 13px; color: var(--text-primary); }
        .pending-host-meta { font-size: 11px; color: var(--text-muted); }
        .pending-host-actions { display: flex; gap: 6px; }
        .pending-btn { padding: 4px 12px; border: none; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .pending-btn.accept { background: rgba(16,185,129,0.15); color: var(--success); }
        .pending-btn.accept:hover { background: var(--success); color: white; }
        .pending-btn.dismiss { background: rgba(100,116,139,0.1); color: var(--text-muted); }
        .pending-btn.dismiss:hover { background: rgba(100,116,139,0.2); color: var(--text-secondary); }
        .host-stats { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; }
        .host-actions { display: flex; gap: 4px; margin-left: 12px; }
        .host-action-btn { padding: 0 8px; height: 24px; border: none; border-radius: 4px; background: var(--bg-primary); color: var(--text-muted); cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; white-space: nowrap; }
        .host-action-btn.reload { font-size: 14px; }
        .host-action-btn.reload:hover { background: rgba(59,130,246,0.15); color: var(--accent); }
        .host-action-btn.reload.disabled { opacity: 0.3; cursor: default; }
        .host-action-btn.reload.disabled:hover { background: var(--bg-primary); color: var(--text-muted); }
        .host-action-btn.reload.spinning { animation: spin 1s linear infinite; pointer-events: none; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .host-action-btn.edit:hover { background: rgba(59,130,246,0.15); color: var(--accent); }
        .host-action-btn.delete:hover { background: rgba(239,68,68,0.15); color: var(--danger); }
        .host-action-btn.confirming { background: var(--danger); color: white; padding: 0 10px; font-weight: 500; }
        .host-action-btn.confirming:hover { background: #b91c1c; color: white; }
        .host-toggle { transition: transform 0.2s; }
        .host-group.collapsed .host-toggle { transform: rotate(-90deg); }
        .host-group.collapsed .host-content { display: none; }
        
        .disk-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .disk-table th { text-align: left; padding: 10px 14px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); border-bottom: 1px solid var(--border); }
        .disk-table th.sortable { cursor: pointer; user-select: none; transition: color 0.15s; }
        .disk-table th.sortable:hover { color: var(--text-primary); }
        .sort-icon { opacity: 0.4; margin-left: 4px; font-size: 10px; }
        .disk-table th.sortable:hover .sort-icon { opacity: 0.7; }
        .disk-table td { padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .disk-table tbody tr { transition: background 0.1s; cursor: pointer; }
        .disk-table tbody tr:hover { background: var(--bg-hover); }
        
        .disk-row.critical { background: rgba(239,68,68,0.04); }
        .disk-row.critical td:first-child { box-shadow: inset 3px 0 0 var(--danger); }
        .disk-row.warning { background: rgba(245,158,11,0.04); }
        .disk-row.warning td:first-child { box-shadow: inset 3px 0 0 var(--warning); }
        
        .device-name { font-weight: 500; font-family: monospace; font-size: 12px; }
        .type-badge { font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 600; margin-left: 8px; text-transform: uppercase; }
        .type-badge.hdd { background: rgba(59,130,246,0.1); color: #3b82f6; }
        .type-badge.ssd { background: rgba(16,185,129,0.1); color: #10b981; }
        .type-badge.nvme { background: rgba(139,92,246,0.1); color: #8b5cf6; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .status-dot.ok { background: var(--success); }
        .status-dot.fail { background: var(--danger); }
        .issue { font-size: 10px; padding: 2px 6px; border-radius: 3px; font-weight: 500; margin-right: 4px; }
        .issue.warning { background: rgba(245,158,11,0.1); color: var(--warning); }
        .issue.critical { background: rgba(239,68,68,0.1); color: var(--danger); }
        .since-incomplete { color: var(--warning); font-style: italic; cursor: help; }
        .delta-period { font-size: 9px; color: var(--text-muted); font-weight: normal; }
        .data-coverage-info { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 6px; padding: 8px 12px; margin-bottom: 12px; font-size: 12px; color: var(--warning); }
        [data-theme="dark"] .data-coverage-info { background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.25); }
        .trend { font-size: 11px; color: var(--warning); }
        .muted { color: var(--text-muted); }
        .mono { font-family: monospace; font-size: 12px; }
        
        .detail-row { display: none; }
        .detail-row.visible { display: table-row; }
        .detail-row td { padding: 0; background: var(--bg-hover); }
        .detail-panel { display: flex; border-top: 1px solid var(--border); }

        .detail-sidebar { min-width: 170px; max-width: 200px; padding: 14px 18px; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 14px; background: var(--bg-hover); flex-shrink: 0; }
        .sidebar-item { display: flex; flex-direction: column; gap: 1px; }
        .sb-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); }
        .sb-value { font-family: monospace; font-size: 13px; font-weight: 500; color: var(--text-primary); word-break: break-all; }
        .sb-sub { font-size: 10px; color: var(--text-muted); }

        .detail-main { flex: 1; min-width: 0; display: flex; flex-direction: column; }

        .attr-section-header { display: flex; justify-content: space-between; align-items: center; padding: 7px 14px; border-bottom: 1px solid var(--border); background: var(--bg-hover); }
        .attr-section-title { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); }
        .show-all-btn { font-size: 11px; color: var(--accent); cursor: pointer; border: none; background: none; font-family: inherit; font-weight: 500; padding: 2px 0; }
        .show-all-btn:hover { text-decoration: underline; }

        .attr-table { width: 100%; border-collapse: collapse; }
        .attr-table th { text-align: left; font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); padding: 5px 14px; border-bottom: 1px solid var(--border); background: var(--bg-hover); }
        .attr-table th.right { text-align: right; }
        .attr-table td { padding: 5px 14px; font-size: 12px; border-bottom: 1px solid rgba(128,128,128,0.08); vertical-align: middle; }
        .attr-table tr:last-child td { border-bottom: none; }
        .attr-name { color: var(--text-primary); font-weight: 500; }
        .attr-name[data-tip], .attr-value[data-tip] { border-bottom: 1px dotted var(--text-muted); cursor: help; position: relative; }
        .attr-name[data-tip]:hover::after, .attr-value[data-tip]:hover::after { content: attr(data-tip); position: absolute; left: 0; top: calc(100% + 6px); background: var(--bg-primary); color: var(--text-secondary); border: 1px solid var(--border); border-radius: 6px; padding: 8px 11px; font-size: 11px; font-weight: 400; line-height: 1.5; width: 260px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.12); pointer-events: none; white-space: normal; }
        .attr-value[data-tip] { border-bottom-style: none; }
        .attr-value[data-tip]:hover::after { left: auto; right: 0; width: auto; white-space: nowrap; }
        .attr-id { color: var(--text-muted); font-size: 10px; margin-left: 5px; }
        .attr-value { font-family: monospace; font-size: 12px; font-weight: 500; text-align: right; }
        .attr-value.val-ok { color: var(--text-primary); }
        .attr-value.val-warning { color: var(--warning); }
        .attr-value.val-danger { color: var(--danger); }
        .attr-delta { font-family: monospace; font-size: 11px; text-align: right; color: var(--text-muted); }
        .attr-delta.delta-up { color: var(--warning); }
        .attr-delta.delta-danger { color: var(--danger); }
        .spark-cell { width: 110px; padding: 3px 10px 3px 4px; }
        .spark-cell svg { width: 100px; height: 24px; display: block; }
        .attr-status { width: 24px; text-align: center; font-size: 11px; }
        .secondary-attrs { display: none; }
        .secondary-attrs.visible { display: table-row-group; }

        .detail-footer { padding: 5px 14px; border-top: 1px solid var(--border); font-size: 10px; color: var(--text-muted); background: var(--bg-hover); }
        .detail-footer span { font-family: monospace; color: var(--text-secondary); }
        
        .footer { margin-top: 24px; text-align: center; font-size: 11px; color: var(--text-muted); }
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .error { background: rgba(239,68,68,0.1); color: var(--danger); padding: 12px 16px; border-radius: 8px; margin-bottom: 24px; }
        .connection-banner { display: none; background: rgba(245,158,11,0.12); color: var(--warning); padding: 10px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; align-items: center; gap: 8px; }
        .connection-banner.visible { display: flex; }
        .connection-banner.error { background: rgba(239,68,68,0.1); color: var(--danger); }
        .connection-banner svg { flex-shrink: 0; }
        
        /* === Settings Modal — fully opaque, hardcoded colors === */
        .settings-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0); z-index: 1000; pointer-events: none; transition: background 0.3s; }
        .settings-overlay.open { background: rgba(0,0,0,0.4); pointer-events: auto; }
        .settings-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 420px; max-width: 92vw; display: flex; flex-direction: column; overflow: hidden; background: #f0f2f5; color: #1a1a2e; box-shadow: -4px 0 24px rgba(0,0,0,0.15); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.25s ease; z-index: 1001; }
        .settings-panel.wide { width: 580px; }
        .settings-overlay.open .settings-panel { transform: translateX(0); }
        .settings-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; background: #ffffff; border-bottom: 1px solid #d5d9e0; flex-shrink: 0; }
        .settings-header h2 { font-size: 16px; font-weight: 700; margin: 0; }
        .settings-close { width: 28px; height: 28px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; background: transparent; color: #888; transition: all 0.15s; }
        .settings-close:hover { background: rgba(0,0,0,0.06); color: #333; }
        /* Settings Tabs */
        .settings-tabs { display: flex; background: #ffffff; border-bottom: 1px solid #d5d9e0; padding: 0 20px; flex-shrink: 0; }
        .settings-tab { padding: 12px 16px; font-size: 13px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.15s; }
        .settings-tab:hover { color: #333; }
        .settings-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .settings-tab-content { display: none; }
        .settings-tab-content.active { display: block; }
        .settings-body { padding: 8px 20px 20px; overflow-y: auto; flex: 1; scrollbar-width: thin; scrollbar-color: transparent transparent; }
        .settings-body:hover { scrollbar-color: rgba(150,150,150,0.4) transparent; }
        .settings-body::-webkit-scrollbar { width: 6px; }
        .settings-body::-webkit-scrollbar-track { background: transparent; }
        .settings-body::-webkit-scrollbar-thumb { background: transparent; border-radius: 3px; }
        .settings-body:hover::-webkit-scrollbar-thumb { background: rgba(150,150,150,0.4); }
        .settings-body::-webkit-scrollbar-thumb:hover { background: rgba(150,150,150,0.6); }
        [data-theme="dark"] .settings-body:hover { scrollbar-color: rgba(200,200,200,0.2) transparent; }
        [data-theme="dark"] .settings-body:hover::-webkit-scrollbar-thumb { background: rgba(200,200,200,0.2); }
        [data-theme="dark"] .settings-body::-webkit-scrollbar-thumb:hover { background: rgba(200,200,200,0.35); }
        .settings-section-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; color: #333; }
        .settings-section-hint { font-size: 12px; color: #777; margin: 0 0 10px 0; }
        .settings-divider { height: 1px; background: #e2e5ea; margin: 20px 0; }
        .settings-row { display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 14px 0; border-bottom: 1px solid #e2e5ea; }
        .settings-body > .settings-row:first-child { padding-top: 4px; }
        .settings-row:last-child { border-bottom: none; }
        .settings-row-label { font-size: 14px; font-weight: 500; color: #333; display: flex; align-items: center; gap: 5px; flex-shrink: 0; white-space: nowrap; }
        .settings-row-label .info-icon, .settings-token-label .info-icon { font-size: 13px; }
        .settings-row .custom-select { min-width: unset; }
        .settings-row .custom-select-trigger { padding: 5px 10px; font-size: 14px; background: transparent; border-color: transparent; }
        .settings-row .custom-select-trigger:hover { border-color: var(--border); }
        .settings-row .custom-select.open .custom-select-trigger { border-color: var(--accent); }
        .settings-row .custom-select-options { min-width: 150px; right: 0; left: auto; }
        .settings-row .info-icon:hover::after, .settings-token-section .info-icon:hover::after { left: -20px; right: auto; transform: none; max-width: 220px; white-space: normal; }
        .settings-token-section { border-top: 1px solid #e2e5ea; margin-top: -1px; }
        .settings-token-label { font-size: 14px; font-weight: 500; color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        /* Unified input styling */
        .settings-input { border: 1px solid #d5d9e0; border-radius: 6px; background: transparent; padding: 6px 10px; font-size: 13px; color: var(--text-primary); outline: none; transition: all 0.15s; }
        .settings-input:hover { border-color: #b0b7c3; }
        .settings-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59,130,246,0.12); }
        .settings-input:disabled { opacity: 0.4; cursor: not-allowed; }
        .settings-input:disabled:hover { border-color: #d5d9e0; }
        .settings-input::placeholder { color: var(--text-muted); }
        /* Number input - no spinners */
        .settings-input[type="number"] { -moz-appearance: textfield; }
        .settings-input[type="number"]::-webkit-outer-spin-button, .settings-input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        /* Specific sizes */
        .settings-input.input-token { width: 180px; text-align: right; font-family: 'SF Mono','Consolas',monospace; }
        .settings-input.input-small { width: 54px; text-align: center; }
        .settings-input.input-medium { width: 64px; text-align: center; }
        /* Dark mode */
        [data-theme="dark"] .settings-input { border-color: #2a3a52; color: #e2e8f0; }
        [data-theme="dark"] .settings-input:hover { border-color: #3d5a80; }
        [data-theme="dark"] .settings-input:focus { border-color: #3b82f6; }
        [data-theme="dark"] .settings-input:disabled:hover { border-color: #2a3a52; }
        /* Legacy classes - redirect to new system */
        .token-inline-input { width: 180px; flex-shrink: 0; text-align: right; border: 1px solid #d5d9e0; border-radius: 6px; background: transparent; padding: 6px 10px; font-family: 'SF Mono','Consolas',monospace; font-size: 13px; color: var(--text-primary); outline: none; transition: all 0.15s; }
        .token-inline-input:hover { border-color: #b0b7c3; }
        .token-inline-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59,130,246,0.12); }
        .settings-number-input { width: 54px; text-align: center; border: 1px solid #d5d9e0; border-radius: 6px; background: transparent; padding: 6px 10px; font-size: 13px; color: var(--text-primary); outline: none; transition: all 0.15s; -moz-appearance: textfield; }
        .settings-number-input::-webkit-outer-spin-button, .settings-number-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .settings-number-input:hover { border-color: #b0b7c3; }
        .settings-number-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59,130,246,0.12); }
        .token-inline-input::placeholder { color: var(--text-muted); font-family: inherit; }
        .token-actions-row { display: flex; gap: 6px; justify-content: flex-end; }
        .token-action-btn { display: flex; align-items: center; gap: 5px; padding: 5px 10px; border: 1px solid #d5d9e0; border-radius: 6px; background: transparent; color: #666; font-size: 12px; cursor: pointer; transition: all 0.15s; }
        .token-action-btn:hover { background: #f0f2f5; color: #333; border-color: #bbb; }
        .hosts-editor { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
        .host-row { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: #ffffff; border: 1px solid #d5d9e0; border-radius: 6px; font-size: 13px; font-family: 'SF Mono', 'Consolas', monospace; }
        .host-row .host-addr { flex: 1; }
        .host-row .host-remove { width: 22px; height: 22px; border-radius: 4px; border: none; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; background: transparent; color: #999; }
        .host-row .host-remove:hover { background: #fee2e2; color: #dc2626; }
        .host-meta { font-size: 11px; color: #888; font-family: inherit; white-space: nowrap; }
        .host-status { font-size: 10px; padding: 1px 6px; border-radius: 4px; font-weight: 600; }
        .host-new { background: #e0f2fe; color: #0284c7; }
        [data-theme="dark"] .host-meta { color: #64748b; }
        [data-theme="dark"] .host-new { background: #0c4a6e; color: #7dd3fc; }
        .hosts-actions { display: flex; gap: 6px; margin-bottom: 4px; }
        .host-input { flex: 1; padding: 6px 10px; border: 1px solid #d5d9e0; border-radius: 6px; font-size: 13px; font-family: 'SF Mono', 'Consolas', monospace; background: #ffffff; color: #1a1a2e; outline: none; }
        .host-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.15); }
        .host-add-btn { padding: 6px 14px; border: none; border-radius: 6px; background: #3b82f6; color: white; font-size: 12px; font-weight: 600; cursor: pointer; }
        .host-add-btn:hover { background: #2563eb; }
        [data-theme="dark"] .host-row { background: #1a2538; border-color: #2a3a52; color: #e2e8f0; }
        [data-theme="dark"] .host-row .host-remove:hover { background: #7f1d1d; color: #fca5a5; }
        [data-theme="dark"] .host-input { background: #1a2538; border-color: #2a3a52; color: #e2e8f0; }
        [data-theme="dark"] .host-input:focus { border-color: #3b82f6; }
        /* Dark mode overrides */
        [data-theme="dark"] .settings-panel { background: #141c2b; color: #e2e8f0; box-shadow: -4px 0 24px rgba(0,0,0,0.4); }
        [data-theme="dark"] .settings-header { background: #1a2538; border-color: #2a3a52; }
        [data-theme="dark"] .settings-header h2 { color: #e2e8f0; }
        [data-theme="dark"] .settings-tabs { background: #1a2538; border-color: #2a3a52; }
        [data-theme="dark"] .settings-tab { color: #64748b; }
        [data-theme="dark"] .settings-tab:hover { color: #94a3b8; }
        [data-theme="dark"] .settings-tab.active { color: #3b82f6; }
        [data-theme="dark"] .settings-close { background: transparent; color: #64748b; }
        [data-theme="dark"] .settings-close:hover { background: rgba(255,255,255,0.06); color: #94a3b8; }
        [data-theme="dark"] .settings-section-title { color: #e2e8f0; }
        [data-theme="dark"] .settings-section-hint { color: #64748b; }
        [data-theme="dark"] .settings-divider { background: #2a3a52; }
        [data-theme="dark"] .settings-row { border-bottom-color: #2a3a52; }
        [data-theme="dark"] .settings-row-label { color: #e2e8f0; }
        [data-theme="dark"] .settings-token-label { color: #e2e8f0; }
        [data-theme="dark"] .settings-token-section { border-top-color: #2a3a52; }
        [data-theme="dark"] .token-inline-input { color: #e2e8f0; border-color: #2a3a52; }
        [data-theme="dark"] .token-inline-input:hover { border-color: #3d5a80; }
        [data-theme="dark"] .token-inline-input:focus { border-color: #3b82f6; background: #1a2538; }
        [data-theme="dark"] .settings-number-input { border-color: #2a3a52; }
        [data-theme="dark"] .settings-number-input:hover { border-color: #3d5a80; }
        [data-theme="dark"] .settings-number-input:focus { border-color: #3b82f6; background: #1a2538; }
        [data-theme="dark"] .token-action-btn { border-color: #2a3a52; color: #64748b; }
        [data-theme="dark"] .token-action-btn:hover { background: rgba(255,255,255,0.06); color: #94a3b8; border-color: #3a4f6e; }
        
        /* Threshold Editor (now inside settings panel) */
        .threshold-content .preset-buttons { display: flex; gap: 8px; margin-bottom: 8px; }
        .threshold-content .preset-btn { flex: 1; padding: 10px 16px; border: 2px solid #d5d9e0; border-radius: 8px; background: #ffffff; color: #374151; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s; }
        .threshold-content .preset-btn:hover { border-color: #9ca3af; }
        .threshold-content .preset-btn.active { border-color: #3b82f6; background: #eff6ff; color: #3b82f6; }
        .threshold-content .preset-hint { font-size: 12px; color: #6b7280; margin: 0 0 16px 0; }
        .threshold-content .copy-from { display: none; align-items: center; gap: 8px; margin: -8px 0 16px 0; font-size: 12px; color: #6b7280; }
        .threshold-content .copy-from.visible { display: flex; }
        .threshold-content .copy-from-label { white-space: nowrap; }
        .threshold-content .copy-from-btn { padding: 3px 10px; border: 1px solid var(--border); border-radius: 4px; background: transparent; color: var(--text-secondary); font-size: 12px; cursor: pointer; transition: all 0.15s; }
        .threshold-content .copy-from-btn:hover { border-color: var(--accent); color: var(--accent); }
        .threshold-content .threshold-section { margin-bottom: 20px; }
        .threshold-content .threshold-section:last-child { margin-bottom: 0; }
        .threshold-content .threshold-section-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #6b7280; margin-bottom: 8px; }
        .threshold-content .threshold-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .threshold-content .threshold-table th { text-align: left; font-weight: 500; color: #6b7280; padding: 8px 8px; border-bottom: 1px solid #e5e7eb; }
        .threshold-content .threshold-table th.col-warning { color: #d97706; }
        .threshold-content .threshold-table th.col-critical { color: #dc2626; }
        .threshold-content .threshold-table td { padding: 8px 8px; border-bottom: 1px solid #e5e7eb; }
        .threshold-content .threshold-table td:first-child { color: #374151; }
        .threshold-content .threshold-input { display: flex; align-items: center; gap: 6px; }
        .threshold-content .threshold-input .custom-select { min-width: 58px; }
        .threshold-content .threshold-input .custom-select-trigger { padding: 6px 8px; font-size: 13px; border: 1px solid #d5d9e0; background: transparent; justify-content: center; gap: 4px; }
        .threshold-content .threshold-input .custom-select-trigger:hover { border-color: #b0b7c3; }
        .threshold-content .threshold-input .custom-select.open .custom-select-trigger { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59,130,246,0.12); }
        .threshold-content .threshold-input .custom-select-trigger .custom-select-arrow { width: 10px; height: 10px; }
        .threshold-content .threshold-input .custom-select-options { min-width: 60px; }
        .threshold-content .threshold-input .custom-select-option { padding: 6px 10px; font-size: 13px; justify-content: center; }
        .threshold-content .threshold-input .custom-select-option::before { display: none; }
        .threshold-content .threshold-input .custom-select.disabled { pointer-events: none; }
        .threshold-content .threshold-input .custom-select.disabled .custom-select-trigger { opacity: 0.4; cursor: not-allowed; }
        .threshold-content .threshold-input input { width: 64px; padding: 6px 10px; border: 1px solid #d5d9e0; border-radius: 6px; background-color: transparent; color: var(--text-primary); font-size: 13px; text-align: center; outline: none; transition: all 0.15s; -moz-appearance: textfield; }
        .threshold-content .threshold-input input::-webkit-outer-spin-button, .threshold-content .threshold-input input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .threshold-content .threshold-input input:hover { border-color: #b0b7c3; }
        .threshold-content .threshold-input input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59,130,246,0.12); }
        .threshold-content .threshold-input input:disabled { opacity: 0.4; cursor: not-allowed; }
        .threshold-content .threshold-input input:disabled:hover { border-color: #d5d9e0; }
        .threshold-content .threshold-input .unit { font-size: 12px; color: #9ca3af; }
        [data-theme="dark"] .threshold-content .preset-btn { background: #141c2b; border-color: #2a3a52; color: #e2e8f0; }
        [data-theme="dark"] .threshold-content .preset-btn:hover { border-color: #4a5568; }
        [data-theme="dark"] .threshold-content .preset-btn.active { background: rgba(59,130,246,0.15); border-color: #3b82f6; }
        [data-theme="dark"] .threshold-content .preset-hint { color: #64748b; }
        [data-theme="dark"] .threshold-content .threshold-section-title { color: #94a3b8; }
        [data-theme="dark"] .threshold-content .threshold-table th { color: #94a3b8; border-color: #2a3a52; }
        [data-theme="dark"] .threshold-content .threshold-table th.col-warning { color: #fbbf24; }
        [data-theme="dark"] .threshold-content .threshold-table th.col-critical { color: #f87171; }
        [data-theme="dark"] .threshold-content .threshold-table td { color: #e2e8f0; border-color: #2a3a52; }
        [data-theme="dark"] .threshold-content .threshold-input .custom-select-trigger { border-color: #2a3a52; }
        [data-theme="dark"] .threshold-content .threshold-input .custom-select-trigger:hover { border-color: #3d5a80; }
        [data-theme="dark"] .threshold-content .threshold-input input { background-color: transparent; border-color: #2a3a52; color: #e2e8f0; }
        [data-theme="dark"] .threshold-content .threshold-input input:hover { border-color: #3d5a80; }
        [data-theme="dark"] .threshold-content .threshold-input input:focus { border-color: #3b82f6; }
        [data-theme="dark"] .threshold-content .threshold-input input:disabled:hover { border-color: #2a3a52; }
        [data-theme="dark"] .threshold-content .threshold-input .unit { color: #64748b; }
        
        @media (max-width: 900px) { .stats { grid-template-columns: repeat(2, 1fr); } .filters { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><svg class="logo-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 5a7 7 0 0 1 7 7"/><path d="M12 19a7 7 0 0 1-7-7"/><circle cx="12" cy="12" r="3.5"/><circle cx="12" cy="12" r="1.2" fill="currentColor" stroke="none"/></svg>diskmind</h1>
            <div class="header-right">
                <span class="timestamp" id="lastUpdate">Loading...</span>
                <button class="btn icon-btn" onclick="toggleTheme()" id="themeBtn" title="Toggle theme">
                    <svg id="themeSun" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    <svg id="themeMoon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
                <button class="btn icon-btn" onclick="toggleSettings()" id="settingsBtn" title="Settings">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                </button>
            </div>
        </header>
        
        <div id="error" class="error" style="display: none;"></div>
        <div id="connectionBanner" class="connection-banner">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.56 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>
            <span id="connectionMsg">Connection lost — retrying…</span>
        </div>
        
        <div class="stats">
            <div class="stat" onclick="filterStatus('')">
                <div class="stat-label">Total</div>
                <div class="stat-value" id="statTotal">-</div>
                <div class="stat-sub" id="statCapacity">-</div>
            </div>
            <div class="stat healthy" onclick="filterStatus('ok')">
                <div class="stat-label">Healthy</div>
                <div class="stat-value" id="statHealthy">-</div>
                <div class="stat-sub">No Issues</div>
            </div>
            <div class="stat warning" onclick="filterStatus('warning')">
                <div class="stat-label">Warning</div>
                <div class="stat-value" id="statWarning">-</div>
                <div class="stat-sub" id="statWarningSub">Need Attention</div>
            </div>
            <div class="stat critical" onclick="filterStatus('critical')">
                <div class="stat-label">Critical</div>
                <div class="stat-value" id="statCritical">-</div>
                <div class="stat-sub">Failing</div>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-group-labeled">
                <span class="filter-group-label">Disks</span>
                <div class="filter-group-controls">
                    <div class="custom-select" id="typeFilterWrapper">
                        <div class="custom-select-trigger" onclick="toggleDropdown('typeFilterWrapper')">
                            <span class="custom-select-value">All Types</span>
                            <svg class="custom-select-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="custom-select-options">
                            <div class="custom-select-option selected" data-value="">All Types</div>
                            <div class="custom-select-option" data-value="HDD">HDD</div>
                            <div class="custom-select-option" data-value="SSD">SSD</div>
                            <div class="custom-select-option" data-value="NVMe">NVMe</div>
                        </div>
                    </div>
                    <input type="hidden" id="typeFilter" value="">
                    <input type="text" id="search" class="search-input" placeholder="Search..." onkeyup="applyFilters()">
                </div>
            </div>
            <div class="filter-separator"></div>
            <div class="filter-group-labeled">
                <span class="filter-group-label">Thresholds <span class="info-icon" data-tip="Warning/critical limits for SMART values. Click ⚙ for details.">ⓘ</span></span>
                <div class="filter-group-controls">
                    <div class="custom-select" id="presetFilterWrapper">
                        <div class="custom-select-trigger" onclick="toggleDropdown('presetFilterWrapper')">
                            <span class="custom-select-value">Backblaze</span>
                            <svg class="custom-select-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="custom-select-options">
                            <div class="custom-select-option" data-value="relaxed">Relaxed</div>
                            <div class="custom-select-option" data-value="conservative">Conservative</div>
                            <div class="custom-select-option selected" data-value="backblaze">Backblaze</div>
                            <div class="custom-select-option" data-value="custom">Custom</div>
                        </div>
                    </div>
                    <input type="hidden" id="presetFilter" value="backblaze">
                    <button class="edit-thresholds-btn" onclick="toggleThresholdEditor()" title="Edit thresholds">⚙</button>
                </div>
            </div>
            <div class="filter-separator"></div>
            <div class="filter-group-labeled">
                <span class="filter-group-label">History <span class="info-icon" data-tip="Time range for issue detection. Event counters only alert if they increased within this period.">ⓘ</span></span>
                <div class="filter-group-controls">
                    <div class="custom-select" id="deltaRangeWrapper">
                        <div class="custom-select-trigger" onclick="toggleDropdown('deltaRangeWrapper')">
                            <span class="custom-select-value">7 days</span>
                            <svg class="custom-select-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="custom-select-options">
                            <div class="custom-select-option" data-value="1h">1 hour</div>
                            <div class="custom-select-option" data-value="24h">24 hours</div>
                            <div class="custom-select-option selected" data-value="7d">7 days</div>
                            <div class="custom-select-option" data-value="30d">30 days</div>
                            <div class="custom-select-option" data-value="90d">90 days</div>
                            <div class="custom-select-option" data-value="all">all time</div>
                        </div>
                    </div>
                    <input type="hidden" id="deltaRange" value="7d">
                </div>
            </div>
            <div class="filter-separator"></div>
            <div class="filter-group-labeled">
                <span class="filter-group-label">Hosts</span>
                <div class="filter-group-controls">
                    <div class="custom-select" id="hostFilterWrapper">
                        <div class="custom-select-trigger" onclick="toggleDropdown('hostFilterWrapper')">
                            <span class="custom-select-value">All Hosts</span>
                            <svg class="custom-select-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="custom-select-options">
                            <div class="custom-select-option selected" data-value="">All Hosts</div>
                        </div>
                    </div>
                    <input type="hidden" id="hostFilter" value="">
                    <button class="host-toolbar-btn" onclick="refreshAllHosts()" title="Fetch SMART data">↻</button>
                    <button id="addHostBtn" class="host-toolbar-btn" onclick="showAddHostInput()" title="Add host">+</button>
                </div>
                <div id="addHostInline" class="add-host-input-group" style="display:none;">
                    <div class="method-toggle" id="addHostMethodToggle">
                        <button type="button" class="method-toggle-btn active" onclick="setAddMethod('ssh')">SSH</button>
                        <button type="button" class="method-toggle-btn" onclick="setAddMethod('push')">Push</button>
                    </div>
                    <span id="addHostSshFields">
                        <input type="text" id="addHostUser" class="add-host-input add-host-user" placeholder="user" title="SSH user (e.g. root)">
                        <span class="add-host-at">@</span>
                    </span>
                    <input type="text" id="addHostInput" class="add-host-input" placeholder="IP or hostname" onkeydown="handleAddHostKey(event)">
                    <span id="addHostPortField">
                        <span class="add-host-at">:</span>
                        <input type="text" id="addHostPort" class="add-host-input add-host-port" placeholder="22" title="SSH port (default: 22)">
                    </span>
                    <button class="add-host-confirm" onclick="addHostFromInput()">✓</button>
                    <button class="add-host-cancel" onclick="hideAddHostInput()">✕</button>
                    <input type="hidden" id="addHostMethod" value="ssh">
                </div>
            </div>
        </div>
        
        <div id="content"><div class="loading">Loading...</div></div>
        
        <footer class="footer">diskmind v{{VERSION}}</footer>
    </div>
    
    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="settings-overlay" onclick="if(event.target===this)toggleSettings()">
        <div class="settings-panel" id="settingsPanel" onclick="event.stopPropagation()">
            <div class="settings-header">
                <h2>Settings</h2>
                <button class="settings-close" onclick="toggleSettings()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="settings-tabs">
                <div class="settings-tab active" data-tab="general" onclick="switchSettingsTab('general')">General</div>
                <div class="settings-tab" data-tab="thresholds" onclick="switchSettingsTab('thresholds')">Thresholds</div>
            </div>
            <div class="settings-body">
                <!-- General Tab -->
                <div class="settings-tab-content active" id="tabGeneral">
                    <div class="settings-row">
                        <span class="settings-row-label">Temperature unit</span>
                        <div class="custom-select" id="tempUnitWrapper">
                            <div class="custom-select-trigger" onclick="toggleDropdown('tempUnitWrapper')">
                                <span class="custom-select-value">Celsius (°C)</span>
                                <svg class="custom-select-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-select-option selected" data-value="C">Celsius (°C)</div>
                                <div class="custom-select-option" data-value="F">Fahrenheit (°F)</div>
                            </div>
                        </div>
                        <input type="hidden" id="tempUnitSelect" value="C">
                    </div>
                    
                    <div class="settings-row">
                        <span class="settings-row-label">Auto-refresh</span>
                        <div class="custom-select" id="refreshIntervalWrapper">
                            <div class="custom-select-trigger" onclick="toggleDropdown('refreshIntervalWrapper')">
                                <span class="custom-select-value">1 minute</span>
                                <svg class="custom-select-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-select-option" data-value="0">Off</div>
                                <div class="custom-select-option" data-value="30">30 seconds</div>
                                <div class="custom-select-option selected" data-value="60">1 minute</div>
                                <div class="custom-select-option" data-value="120">2 minutes</div>
                                <div class="custom-select-option" data-value="300">5 minutes</div>
                                <div class="custom-select-option" data-value="600">10 minutes</div>
                            </div>
                        </div>
                        <input type="hidden" id="refreshIntervalSelect" value="60">
                    </div>
                    
                    <div class="settings-row">
                        <span class="settings-row-label">Data retention <span class="info-icon" data-tip="How long SMART readings are kept. Older data is deleted automatically.">ⓘ</span></span>
                        <div class="custom-select" id="retentionWrapper">
                            <div class="custom-select-trigger" onclick="toggleDropdown('retentionWrapper')">
                                <span class="custom-select-value">1 year</span>
                                <svg class="custom-select-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-select-option" data-value="30">30 days</div>
                                <div class="custom-select-option" data-value="90">90 days</div>
                                <div class="custom-select-option" data-value="180">6 months</div>
                                <div class="custom-select-option selected" data-value="365">1 year</div>
                                <div class="custom-select-option" data-value="730">2 years</div>
                                <div class="custom-select-option" data-value="0">Forever</div>
                            </div>
                        </div>
                        <input type="hidden" id="retentionSelect" value="365">
                    </div>
                    
                    <div class="settings-row">
                        <span class="settings-row-label">Rate limit <span class="info-icon" data-tip="Limit push requests per IP address. Set to 0 to disable rate limiting.">ⓘ</span></span>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="number" id="rateLimitMax" class="settings-number-input" value="10" min="0" max="1000" onblur="saveRateLimit()" onkeydown="if(event.key==='Enter'){this.blur()}">
                            <span style="font-size: 13px; color: var(--text-muted);">per</span>
                            <input type="number" id="rateLimitWindow" class="settings-number-input" value="60" min="1" max="3600" onblur="saveRateLimit()" onkeydown="if(event.key==='Enter'){this.blur()}">
                            <span style="font-size: 13px; color: var(--text-muted);">sec</span>
                        </div>
                    </div>
                    
                    <div class="settings-token-section">
                        <div class="settings-row" style="border-bottom: none; padding-bottom: 10px;">
                            <span class="settings-row-label">Push token <span class="info-icon" data-tip="Shared secret for authenticating push agents. Leave empty to allow unauthenticated push.">ⓘ</span></span>
                            <input type="password" id="pushTokenInput" class="token-inline-input" placeholder="Not set" onblur="savePushToken()" onkeydown="if(event.key==='Enter'){this.blur()}">
                        </div>
                        <div class="token-actions-row">
                            <button class="token-action-btn" onclick="toggleTokenVisibility()" id="tokenVisBtn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                Show
                            </button>
                            <button class="token-action-btn" onclick="generateToken()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                                Generate
                            </button>
                            <button class="token-action-btn" onclick="copyToken()" id="copyTokenBtn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                Copy
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Thresholds Tab -->
                <div class="settings-tab-content" id="tabThresholds">
                    <div class="threshold-content">
                        <div class="preset-buttons">
                            <button class="preset-btn" data-preset="relaxed" onclick="selectPreset('relaxed')">Relaxed</button>
                            <button class="preset-btn" data-preset="conservative" onclick="selectPreset('conservative')">Conservative</button>
                            <button class="preset-btn" data-preset="backblaze" onclick="selectPreset('backblaze')">Backblaze</button>
                            <button class="preset-btn" data-preset="custom" onclick="selectPreset('custom')">Custom</button>
                        </div>
                        <p class="preset-hint" id="presetHint">Relaxed: Higher thresholds for home/lab use. Fewer alerts.</p>
                        <div class="copy-from" id="copyFromRow">
                            <span class="copy-from-label">Copy from:</span>
                            <button class="copy-from-btn" onclick="copyFromPreset('relaxed')">Relaxed</button>
                            <button class="copy-from-btn" onclick="copyFromPreset('conservative')">Conservative</button>
                            <button class="copy-from-btn" onclick="copyFromPreset('backblaze')">Backblaze</button>
                        </div>
                        
                        <div class="threshold-section">
                            <div class="threshold-section-title">ATA / SATA (HDD & SSD)</div>
                            <table class="threshold-table" id="ataThresholds">
                                <thead><tr><th>Attribute</th><th class="col-warning">Warning</th><th class="col-critical">Critical</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        
                        <div class="threshold-section">
                            <div class="threshold-section-title">NVMe</div>
                            <table class="threshold-table" id="nvmeThresholds">
                                <thead><tr><th>Attribute</th><th class="col-warning">Warning</th><th class="col-critical">Critical</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    let data = { disks: [], hosts: [], stats: {}, trends: {}, thresholds: {} };
    let historyCache = {};
    let statusFilter = '';
    let deltaRangeDays = 30;
    let settingsData = null;
    let tempUnit = 'C'; // 'C' for Celsius, 'F' for Fahrenheit

    // Health-relevant attributes by type (order matters - shown first)
    // Attribute descriptions for tooltips
    const ATTR_TIPS = {
        // ATA health
        'Reallocated_Sector_Ct': 'Number of defective sectors moved to a reserved spare area. A slowly rising count is normal aging; rapid growth suggests surface degradation.',
        'Reported_Uncorrect': 'Read or write errors that the error correction could not fix. Occasional errors can occur; a growing count points to media problems.',
        'Command_Timeout': 'Operations the drive failed to complete in time. Often caused by cable, power supply, or controller issues rather than the drive itself.',
        'Current_Pending_Sector': 'Sectors flagged as suspicious, waiting to be tested on the next write. May resolve on their own or become reallocated.',
        'Offline_Uncorrectable': 'Bad sectors found during background scans that could not be repaired or remapped. Indicates permanent media damage at those locations.',
        'Temperature_Celsius': 'Current drive temperature in \u00b0C. Most drives are rated for continuous operation up to 55-60\u00b0C.',
        'Airflow_Temperature_Cel': 'Current drive temperature in \u00b0C. Most drives are rated for continuous operation up to 55-60\u00b0C.',
        // ATA secondary
        'Raw_Read_Error_Rate': 'Rate of hardware read errors. On Seagate drives this is a composite value where the large raw number is normal and not an error count.',
        'Spin_Up_Time': 'Time in milliseconds for the platters to reach operating speed. Increases can indicate motor or bearing wear.',
        'Start_Stop_Count': 'Number of spindle start/stop cycles. Drives are typically rated for 50,000 or more cycles.',
        'Seek_Error_Rate': 'Rate of positioning errors when the head moves to a track. On Seagate drives this is a composite value; the large raw number is normal.',
        'Spin_Retry_Count': 'Number of times the drive needed more than one attempt to spin up. Non-zero values can point to power supply or motor issues.',
        'Power_Off_Retract_Count': 'Times the heads retracted due to power loss rather than a clean shutdown. Normal for drives that experience occasional outages.',
        'Load_Cycle_Count': 'Number of head load/unload cycles. Drives are typically rated for 300,000-600,000 cycles over their lifetime.',
        'UDMA_CRC_Error_Count': 'Data transfer errors between drive and controller, usually caused by a damaged or loose SATA cable.',
        'Multi_Zone_Error_Rate': 'Rate of errors when writing data across multiple zones. Can indicate problems with the write head or media surface.',
        'Head_Flying_Hours': 'Total time the read/write heads have been positioned over the platters. Similar to power-on hours but excludes idle/parked time.',
        'Total_LBAs_Written': 'Total logical block addresses written. Multiply by 512 bytes for approximate total data written to the drive.',
        'Total_LBAs_Read': 'Total logical block addresses read. Multiply by 512 bytes for approximate total data read from the drive.',
        'Power_On_Hours': 'Total accumulated hours the drive has been powered on.',
        'Power_Cycle_Count': 'Number of full power on/off cycles. Frequent cycling can stress components more than continuous operation.',
        'End-to-End_Error': 'Errors detected in the data path between the drive cache and the host interface. Should normally be zero.',
        'Runtime_Bad_Block': 'Bad blocks found during normal operation. Similar to reallocated sectors but tracked separately by some vendors.',
        'High_Fly_Writes': 'Write operations where the head was further from the platter surface than intended. Can lead to weak writes.',
        'G-Sense_Error_Rate': 'Shock and vibration events detected by the built-in accelerometer. Common in portable or poorly mounted drives.',
        'Hardware_ECC_Recovered': 'Number of errors corrected by hardware error correction. A rising count is normal as the drive ages.',
        // NVMe health
        'Percentage_Used': 'Vendor estimate of life consumed based on actual writes vs. rated endurance (TBW). Reaching 100% means the rated lifespan is used up, though many drives continue to work beyond that.',
        'Available_Spare': 'Percentage of reserved spare flash blocks still available for wear leveling. Starts at 100% and decreases over the lifetime of the drive.',
        'Available_Spare_Threshold': 'Vendor-defined minimum for available spare blocks. When Available Spare drops below this value, the drive raises a warning.',
        'Critical_Warning': 'Hardware-level warning flags reported by the NVMe controller. A value of 0 means no warnings are active.',
        'Media_and_Data_Integrity_Errors': 'Count of unrecovered data errors from the flash media. A value of 0 is expected; any increase means cells are failing.',
        'Error_Information_Log_Entries': 'Total number of error events logged by the drive. Some entries are normal over time; a sudden jump can indicate a new issue.',
        'Temperature': 'Current drive temperature in \u00b0C. NVMe drives typically throttle performance above 70\u00b0C to protect themselves.',
        'Unsafe_Shutdowns': 'Number of times the drive lost power without a clean shutdown command. Does not directly indicate damage, but high counts increase the risk of metadata issues.',
        // NVMe secondary
        'Data_Units_Read': 'Total data read in 512-byte units x1000. Divide by ~2 million to approximate terabytes read.',
        'Data_Units_Written': 'Total data written in 512-byte units x1000. Divide by ~2 million to approximate terabytes written.',
        'Host_Read_Commands': 'Total number of read commands issued by the host system.',
        'Host_Write_Commands': 'Total number of write commands issued by the host system.',
        'Controller_Busy_Time': 'Total time in minutes that the controller was busy handling I/O commands.',
        'Warning_Comp._Temperature_Time': 'Total minutes the drive spent above its warning temperature threshold.',
        'Critical_Comp._Temperature_Time': 'Total minutes the drive spent above its critical temperature threshold. Any non-zero value means the drive was at risk of damage.',
        'Temperature_Sensor_1': 'Reading from the first on-board temperature sensor, typically near the controller.',
        'Temperature_Sensor_2': 'Reading from the second on-board temperature sensor, typically near the NAND flash.',
        'Thermal_Temp._1_Transition_Count': 'Number of times the drive crossed into thermal throttling state 1 to manage heat.',
        'Thermal_Temp._1_Total_Time': 'Total time spent in thermal throttling state 1.',
    };

    const HEALTH_ATTRS = {
        ata: [
            {key: 'Reallocated_Sector_Ct', id: 5, label: 'Reallocated Sector Ct'},
            {key: 'Reported_Uncorrect', id: 187, label: 'Reported Uncorrect'},
            {key: 'Command_Timeout', id: 188, label: 'Command Timeout'},
            {key: 'Current_Pending_Sector', id: 197, label: 'Current Pending Sector'},
            {key: 'Offline_Uncorrectable', id: 198, label: 'Offline Uncorrectable'},
            {key: 'Temperature_Celsius', id: 194, label: 'Temperature'},
        ],
        nvme: [
            {key: 'Percentage_Used', label: 'Percentage Used'},
            {key: 'Available_Spare', label: 'Available Spare'},
            {key: 'Critical_Warning', label: 'Critical Warning'},
            {key: 'Media_and_Data_Integrity_Errors', label: 'Media & Data Integrity Errors'},
            {key: 'Error_Information_Log_Entries', label: 'Error Log Entries'},
            {key: 'Temperature', label: 'Temperature'},
        ]
    };
    // Alternate temperature key for ATA
    const TEMP_KEYS = ['Temperature_Celsius', 'Airflow_Temperature_Cel', 'Temperature'];

    // Key metrics shown in the top strip
    const KEY_METRIC_ATTRS = ['Power_On_Hours', 'Power_Cycle_Count', 'Power_Cycles'];

    function getTemp(attrs) {
        for (const k of TEMP_KEYS) { if (attrs[k] != null) return attrs[k]; }
        return null;
    }
    
    function formatTemp(celsius) {
        if (celsius == null || celsius === '-') return '-';
        const c = parseInt(celsius);
        if (isNaN(c)) return '-';
        if (tempUnit === 'F') {
            return Math.round(c * 9/5 + 32);
        }
        return c;
    }
    
    function getTempSymbol() {
        return tempUnit === 'F' ? '°F' : '°C';
    }

    function fmtHours(h) {
        if (!h) return '-';
        h = parseInt(h);
        if (h >= 1000) return (h / 1000).toFixed(1) + 'k';
        return String(h);
    }

    function fmtDuration(h) {
        if (!h) return '';
        h = parseInt(h);
        const days = Math.round(h / 24);
        if (days >= 365) {
            const years = (days / 365).toFixed(1);
            return years + (years === '1.0' ? ' year' : ' years');
        }
        if (days >= 30) {
            const months = Math.round(days / 30.44);
            return months + (months === 1 ? ' month' : ' months');
        }
        if (days >= 7) {
            const weeks = Math.round(days / 7);
            return weeks + (weeks === 1 ? ' week' : ' weeks');
        }
        return days + (days === 1 ? ' day' : ' days');
    }

    function fmtBytes(bytes) {
        if (!bytes || bytes <= 0) return '0 B';
        const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        const val = bytes / Math.pow(1024, i);
        return val.toFixed(val >= 100 ? 0 : val >= 10 ? 1 : 2) + ' ' + units[i];
    }

    function formatAge(ts, compact) {
        if (!ts) return '-';
        const d = new Date(ts.replace(' ', 'T') + 'Z');
        const sec = Math.floor((new Date() - d) / 1000);
        if (sec < 60) return compact ? '1min' : 'just now';
        const min = Math.floor(sec / 60);
        if (min < 60) return compact ? min + 'min' : min + 'm ago';
        const hr = Math.floor(min / 60);
        if (hr < 24) return compact ? hr + 'h' : hr + 'h ago';
        const days = Math.floor(hr / 24);
        return compact ? days + 'd' : days + 'd ago';
    }

    // Keys that should be displayed as human-readable byte values
    const LBA_KEYS = new Set(['Total_LBAs_Written', 'Total_LBAs_Read']);
    const DATA_UNIT_KEYS = new Set(['Data_Units_Read', 'Data_Units_Written']);

    // SVG sparkline generator
    function sparkSVG(points, color, opts = {}) {
        if (!points || points.length < 2) {
            // Flat dashed line for no data or single point
            const y = 20;
            return `<svg viewBox="0 0 100 24" preserveAspectRatio="none"><line x1="0" y1="${y}" x2="100" y2="${y}" stroke="currentColor" stroke-width="1" stroke-dasharray="3,3" opacity="0.25"/></svg>`;
        }
        const w = 100, h = 24, pad = 2;
        let min = Math.min(...points), max = Math.max(...points);
        if (min === max) { min -= 1; max += 1; } // avoid div by zero
        const range = max - min;
        const coords = points.map((v, i) => {
            const x = (i / (points.length - 1)) * w;
            const y = pad + (1 - (v - min) / range) * (h - 2 * pad);
            return `${x.toFixed(1)},${y.toFixed(1)}`;
        });
        const line = coords.join(' L');
        const fill = coords.join(' L') + ` L${w},${h} L0,${h} Z`;
        const fillColor = color === '#f59e0b' ? 'rgba(245,158,11,0.12)' :
                          color === '#ef4444' ? 'rgba(239,68,68,0.12)' :
                          color === '#10b981' ? 'rgba(16,185,129,0.08)' :
                          'rgba(59,130,246,0.08)';
        return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
            <path d="M${fill}" fill="${fillColor}"/>
            <path d="M${line}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round"/>
        </svg>`;
    }

    // Seagate composite value decoder
    // Seagate packs multiple counters into 48-bit raw values:
    // - Command_Timeout (#188): [5-4]=cmds>7.5s, [3-2]=cmds>5s, [1-0]=actual timeouts
    // - Raw_Read_Error_Rate (#1): [5-4]=error count, [3-0]=total operations
    // - Seek_Error_Rate (#7): [5-4]=error count, [3-0]=total seeks
    const SEAGATE_COMPOSITE_ATTRS = {
        'Command_Timeout': { extract: 'low16' },       // actual timeouts in low 16 bits
        'Raw_Read_Error_Rate': { extract: 'high16' },   // errors in high 16 bits
        'Seek_Error_Rate': { extract: 'high16' },       // errors in high 16 bits
    };

    function isSeagateComposite(attrKey, rawValue) {
        if (!SEAGATE_COMPOSITE_ATTRS[attrKey]) return false;
        // Composite values are >65535 (more than 16 bits used)
        return parseInt(rawValue) > 65535;
    }

    function decodeSeagateValue(attrKey, rawValue) {
        const raw = parseInt(rawValue);
        if (!isSeagateComposite(attrKey, rawValue)) return raw;
        const spec = SEAGATE_COMPOSITE_ATTRS[attrKey];
        if (spec.extract === 'low16') return raw & 0xFFFF;
        if (spec.extract === 'high16') return (raw >> 32) & 0xFFFF;
        return raw;
    }
    
    // Custom dropdown functions
    function toggleDropdown(wrapperId) {
        const wrapper = document.getElementById(wrapperId);
        const wasOpen = wrapper.classList.contains('open');
        
        // Close all dropdowns
        document.querySelectorAll('.custom-select.open').forEach(el => el.classList.remove('open'));
        
        // Toggle this one
        if (!wasOpen) {
            wrapper.classList.add('open');
        }
    }
    
    function selectOption(wrapperId, value, label, callback) {
        const wrapper = document.getElementById(wrapperId);
        const hiddenInput = wrapper.nextElementSibling;
        const valueDisplay = wrapper.querySelector('.custom-select-value');
        
        // Update hidden input
        if (hiddenInput && hiddenInput.tagName === 'INPUT') {
            hiddenInput.value = value;
        }
        
        // Update displayed value
        valueDisplay.textContent = label;
        
        // Update selected state
        wrapper.querySelectorAll('.custom-select-option').forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.value === value);
        });
        
        // Close dropdown
        wrapper.classList.remove('open');
        
        // Execute callback
        if (callback) callback(value);
    }
    
    function initDropdowns() {
        // Add click handlers to all options
        document.querySelectorAll('.custom-select-option').forEach(opt => {
            opt.addEventListener('click', (e) => {
                e.stopPropagation();
                const wrapper = opt.closest('.custom-select');
                const value = opt.dataset.value;
                const label = opt.textContent;
                
                // Determine callback based on wrapper id
                let callback = null;
                if (wrapper.id === 'typeFilterWrapper') callback = applyFilters;
                else if (wrapper.id === 'presetFilterWrapper') callback = (v) => changePreset(v);
                else if (wrapper.id === 'deltaRangeWrapper') callback = (v) => updateDeltaFromDropdown(v);
                else if (wrapper.id === 'hostFilterWrapper') callback = applyFilters;
                else if (wrapper.id === 'tempUnitWrapper') callback = () => saveTempUnit();
                else if (wrapper.id === 'refreshIntervalWrapper') callback = () => saveRefreshInterval();
                else if (wrapper.id === 'retentionWrapper') callback = () => saveRetention();
                
                selectOption(wrapper.id, value, label, callback);
            });
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-select')) {
                document.querySelectorAll('.custom-select.open').forEach(el => el.classList.remove('open'));
            }
        });
    }
    
    function setDropdownValue(wrapperId, value) {
        const wrapper = document.getElementById(wrapperId);
        if (!wrapper) return;
        
        const option = wrapper.querySelector(`.custom-select-option[data-value="${value}"]`);
        if (option) {
            const label = option.textContent;
            const valueDisplay = wrapper.querySelector('.custom-select-value');
            const hiddenInput = wrapper.nextElementSibling;
            
            if (hiddenInput && hiddenInput.tagName === 'INPUT') {
                hiddenInput.value = value;
            }
            valueDisplay.textContent = label;
            
            wrapper.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.value === value);
            });
        }
    }
    
    // Format time duration: <1h = Xmin, <1d = Xh, else Xd
    function formatDuration(ms) {
        const minutes = ms / 60000;
        const hours = ms / 3600000;
        const days = ms / 86400000;
        if (days >= 1) return Math.floor(days) + 'd';
        if (hours >= 1) return Math.floor(hours) + 'h';
        return Math.max(1, Math.floor(minutes)) + 'min';
    }

    function getAttrColor(attrKey, value, diskType) {
        // Decode Seagate composites before threshold check
        const checkVal = (diskType !== 'NVMe') ? decodeSeagateValue(attrKey, value) : value;
        // Check against current thresholds
        const th = data.thresholds || {};
        const ruleSet = diskType === 'NVMe' ? (th.nvme || {}) : (th.ata || {});
        for (const [attr, rule] of Object.entries(ruleSet.critical || {})) {
            if (attr === attrKey && checkThreshold(checkVal, rule)) return '#ef4444';
        }
        for (const [attr, rule] of Object.entries(ruleSet.warning || {})) {
            if (attr === attrKey && checkThreshold(checkVal, rule)) return '#f59e0b';
        }
        // Temperature: always blue sparkline
        if (TEMP_KEYS.includes(attrKey) || attrKey === 'Temperature') return '#3b82f6';
        return '#3b82f6';
    }

    function checkThreshold(val, rule) {
        const v = parseFloat(val), t = rule.value;
        if (isNaN(v)) return false;
        if (rule.op === '>') return v > t;
        if (rule.op === '>=') return v >= t;
        if (rule.op === '<') return v < t;
        if (rule.op === '<=') return v <= t;
        if (rule.op === '==') return v === t;
        return false;
    }
    
    // Cumulative event counters - used for display hints (delta suffix)
    // Actual filtering is now done in backend
    const CUMULATIVE_EVENT_ATTRS = new Set([
        'Command_Timeout',
        'Reported_Uncorrect', 
        'UDMA_CRC_Error_Count',
        'Unsafe_Shutdowns',
        'Error_Information_Log_Entries',
        'Power_Off_Retract_Count',
        'G-Sense_Error_Rate',
    ]);

    function getValClass(attrKey, value, diskType) {
        const checkVal = (diskType !== 'NVMe') ? decodeSeagateValue(attrKey, value) : value;
        const th = data.thresholds || {};
        const ruleSet = diskType === 'NVMe' ? (th.nvme || {}) : (th.ata || {});
        for (const [attr, rule] of Object.entries(ruleSet.critical || {})) {
            if (attr === attrKey && checkThreshold(checkVal, rule)) return 'val-danger';
        }
        for (const [attr, rule] of Object.entries(ruleSet.warning || {})) {
            if (attr === attrKey && checkThreshold(checkVal, rule)) return 'val-warning';
        }
        return 'val-ok';
    }

    function getValTip(attrKey, value, diskType, composite) {
        const checkVal = (diskType !== 'NVMe') ? decodeSeagateValue(attrKey, value) : value;
        const th = data.thresholds || {};
        const ruleSet = diskType === 'NVMe' ? (th.nvme || {}) : (th.ata || {});
        let level = '', rule = null;
        for (const [attr, r] of Object.entries(ruleSet.critical || {})) {
            if (attr === attrKey && checkThreshold(checkVal, r)) { level = 'Critical'; rule = r; break; }
        }
        if (!level) {
            for (const [attr, r] of Object.entries(ruleSet.warning || {})) {
                if (attr === attrKey && checkThreshold(checkVal, r)) { level = 'Warning'; rule = r; break; }
            }
        }
        if (!level) return '';
        const opLabel = rule.op === '>' ? 'above' : rule.op === '>=' ? 'at or above' : rule.op === '<' ? 'below' : rule.op === '<=' ? 'at or below' : '';
        let tip = `${level}: ${checkVal} is ${opLabel} ${rule.value}`;
        if (composite) tip += ` (decoded from raw ${value})`;
        return tip;
    }

    function getStatusIcon(attrKey, value, diskType) {
        const checkVal = (diskType !== 'NVMe') ? decodeSeagateValue(attrKey, value) : value;
        const th = data.thresholds || {};
        const ruleSet = diskType === 'NVMe' ? (th.nvme || {}) : (th.ata || {});
        for (const [attr, rule] of Object.entries(ruleSet.critical || {})) {
            if (attr === attrKey && checkThreshold(checkVal, rule)) return '<span style="color:var(--danger)">✕</span>';
        }
        for (const [attr, rule] of Object.entries(ruleSet.warning || {})) {
            if (attr === attrKey && checkThreshold(checkVal, rule)) return '<span style="color:var(--warning)">⚠</span>';
        }
        // Only show checkmark for health-monitored attributes
        const healthKeys = [...(HEALTH_ATTRS.ata || []), ...(HEALTH_ATTRS.nvme || [])].map(a => a.key);
        if (healthKeys.includes(attrKey) && !TEMP_KEYS.includes(attrKey) && attrKey !== 'Temperature') {
            return '<span style="color:var(--success)">✓</span>';
        }
        return '';
    }

    function renderAttrRow(attrDef, attrs, hist, diskType, showId, dataCoversFilter, dataAgeMs) {
        const key = attrDef.key;
        let val = attrs[key];
        // Temperature fallback
        if (val == null && TEMP_KEYS.includes(key)) {
            for (const tk of TEMP_KEYS) { if (attrs[tk] != null) { val = attrs[tk]; break; } }
        }
        if (val == null) val = 0;

        // Decode Seagate composite values for display and threshold checks
        let displayVal = val;
        let composite = false;
        if (diskType !== 'NVMe' && isSeagateComposite(key, val)) {
            displayVal = decodeSeagateValue(key, val);
            composite = true;
        }

        const h = hist ? hist[key] : null;
        const delta = h ? h.delta : 0;
        const points = h ? h.points : null;
        const color = getAttrColor(key, val, diskType);
        const valClass = getValClass(key, val, diskType);
        const statusIcon = getStatusIcon(key, val, diskType);
        const valTip = getValTip(key, val, diskType, composite);
        const idStr = showId && attrDef.id ? `<span class="attr-id">#${attrDef.id}</span>` : '';

        let deltaStr = '—';
        let deltaClass = '';
        if (delta > 0) { 
            deltaStr = `+${delta} ↑`; 
            deltaClass = 'delta-up'; 
        } else if (delta < 0) { 
            deltaStr = `${delta} ↓`; 
        }
        
        // Add period suffix if data doesn't cover filter period
        if (delta !== 0 && !dataCoversFilter && dataAgeMs > 0) {
            deltaStr += ` <span class="delta-period">(${formatDuration(dataAgeMs)})</span>`;
        }

        // Suffix for special attrs
        let suffix = '';
        if (key === 'Percentage_Used' || key === 'Available_Spare') suffix = '%';
        if (TEMP_KEYS.includes(key) || key === 'Temperature') suffix = '°C';

        // Value tooltip: threshold explanation, with composite decode info if applicable
        const valTipAttr = valTip ? ` data-tip="${valTip}"` : '';

        const tip = ATTR_TIPS[key] || '';
        const tipAttr = tip ? ` data-tip="${tip}"` : '';

        return `<tr>
            <td><span class="attr-name"${tipAttr}>${attrDef.label}</span>${idStr}</td>
            <td class="attr-value ${valClass}"${valTipAttr}>${displayVal}${suffix}</td>
            <td class="attr-delta ${deltaClass}">${deltaStr}</td>
            <td class="spark-cell">${sparkSVG(points, color)}</td>
            <td class="attr-status">${statusIcon}</td>
        </tr>`;
    }

    async function loadHistory(force = false) {
        try {
            const resp = await fetch(`/api/history?days=${deltaRangeDays}`);
            if (resp.ok) historyCache = await resp.json();
        } catch (e) { console.warn('History load failed:', e); }
    }

    let _consecutiveFailures = 0;

    function showConnectionBanner(msg, isError) {
        const banner = document.getElementById('connectionBanner');
        document.getElementById('connectionMsg').textContent = msg;
        banner.classList.toggle('error', !!isError);
        banner.classList.add('visible');
    }

    function hideConnectionBanner() {
        document.getElementById('connectionBanner').classList.remove('visible');
    }

    async function loadData() {
        try {
            const [diskResp] = await Promise.all([
                fetch('/api/disks'),
                loadHistory(),
            ]);
            if (!diskResp.ok) throw new Error('HTTP ' + diskResp.status);
            data = await diskResp.json();
            renderData();
            document.getElementById('error').style.display = 'none';
            if (_consecutiveFailures > 0) {
                hideConnectionBanner();
                _consecutiveFailures = 0;
            }
        } catch (e) {
            _consecutiveFailures++;
            if (_consecutiveFailures === 1) {
                showConnectionBanner('Connection lost \u2014 retrying\u2026');
            } else {
                const s = _consecutiveFailures === 2 ? 'retry' : 'retries';
                showConnectionBanner('Connection lost \u2014 ' + _consecutiveFailures + ' failed ' + s, _consecutiveFailures >= 5);
            }
        }
    }
    
    // Refresh history periodically
    setInterval(loadHistory, 120000);
    
    function renderData() {
        // Save expanded detail rows and secondary sections before re-render
        const expandedDetails = new Set();
        const expandedSections = new Set();
        document.querySelectorAll('.detail-row.visible').forEach(el => expandedDetails.add(el.id));
        document.querySelectorAll('.secondary-attrs.visible').forEach(el => expandedSections.add(el.id));

        // Update stats
        document.getElementById('statCritical').textContent = data.stats.critical || 0;
        document.getElementById('statWarning').textContent = data.stats.warning || 0;
        document.getElementById('statWarningSub').textContent = data.stats.warning === 1 ? 'Needs Attention' : 'Need Attention';
        document.getElementById('statHealthy').textContent = data.stats.healthy || 0;
        document.getElementById('statTotal').textContent = data.stats.total || 0;
        document.getElementById('statCapacity').textContent = (data.stats.total_capacity_tb || 0) + ' TB';
        document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
        
        // Update host filter dropdown
        const hostFilter = document.getElementById('hostFilter');
        const currentHost = hostFilter.value;
        const hostWrapper = document.getElementById('hostFilterWrapper');
        const hostOptions = hostWrapper.querySelector('.custom-select-options');
        hostOptions.innerHTML = `<div class="custom-select-option${!currentHost ? ' selected' : ''}" data-value="">All Hosts</div>` +
            data.hosts.map(h => `<div class="custom-select-option${h === currentHost ? ' selected' : ''}" data-value="${h}">${h}</div>`).join('');
        
        // Re-attach click handlers for new options
        hostOptions.querySelectorAll('.custom-select-option').forEach(opt => {
            opt.addEventListener('click', (e) => {
                e.stopPropagation();
                selectOption('hostFilterWrapper', opt.dataset.value, opt.textContent, applyFilters);
            });
        });
        
        // Group disks by host
        const byHost = {};
        data.disks.forEach(d => {
            if (!byHost[d.host]) byHost[d.host] = [];
            byHost[d.host].push(d);
        });
        
        // Get host_status from API response
        const hostStatus = data.host_status || {};
        const pushAttempts = data.push_attempts || {};
        
        // Build map of IP -> full config entry
        // Format: "ssh:user@host" or "ssh:user@host:port" or "push:host"
        const hostConfigMap = {};
        (settingsData?.hosts || []).forEach(h => {
            let method = 'ssh', rest = h;
            if (h.startsWith('push:')) { method = 'push'; rest = h.slice(5); }
            else if (h.startsWith('ssh:')) { method = 'ssh'; rest = h.slice(4); }
            let ip = rest.includes('@') ? rest.split('@')[1] : rest;
            // Extract port if present (format: host:port)
            let port = '';
            if (method === 'ssh' && ip.includes(':')) {
                const parts = ip.split(':');
                ip = parts[0];
                port = parts[1];
            }
            hostConfigMap[ip] = { full: h, method, rest, ip, port };
        });
        
        // Helper to get user for a host
        const getHostUser = (host) => {
            const entry = hostConfigMap[host];
            if (!entry) return null;
            return entry.rest.includes('@') ? entry.rest.split('@')[0] : null;
        };
        
        // Helper to get method for a host
        const getHostMethod = (host) => {
            const entry = hostConfigMap[host];
            return entry ? entry.method : 'ssh';
        };
        
        // Helper to get port for a host
        const getHostPort = (host) => {
            const entry = hostConfigMap[host];
            return entry?.port || '';
        };
        
        // Render hosts (all configured hosts, even those without disks)
        let html = '';
        for (const host of data.hosts) {
            const disks = byHost[host] || [];
            const status = hostStatus[host] || {};
            const hasDisks = disks.length > 0;
            const hostUser = getHostUser(host);
            const hostMethod = getHostMethod(host);
            const hostPort = getHostPort(host);
            const fullHostEntry = hostConfigMap[host]?.full || host;
            
            // User display (small text if != root)
            const userDisplay = hostUser ? `<span class="host-user">${hostUser}@</span>` : '';
            const methodBadge = `<span class="host-method-badge ${hostMethod}">${hostMethod}</span>`;
            const pushHint = (hostMethod === 'ssh' && pushAttempts[host])
                ? `<span class="push-hint" data-tip="This host attempted to push data ${pushAttempts[host].attempts}×. Consider switching to Push mode.">⚡</span>`
                : '';
            
            // Inline edit form (hidden by default, replaces host name when editing)
            const hostEditForm = `<div class="host-edit-form" id="hostEdit-${host.replace(/\\./g, '-')}" style="display:none;">
                <div class="method-toggle">
                    <button type="button" class="method-toggle-btn${hostMethod === 'ssh' ? ' active' : ''}" onclick="setEditMethod('${host}', 'ssh')">SSH</button>
                    <button type="button" class="method-toggle-btn${hostMethod === 'push' ? ' active' : ''}" onclick="setEditMethod('${host}', 'push')">Push</button>
                </div>
                <span class="host-edit-ssh-fields" id="hostEditSsh-${host.replace(/\\./g, '-')}" style="${hostMethod === 'push' ? 'display:none' : ''}">
                    <input type="text" class="host-edit-input host-edit-user" value="${hostUser || ''}" placeholder="user">
                    <span class="host-edit-at">@</span>
                </span>
                <input type="text" class="host-edit-input host-edit-ip" value="${host}">
                <span class="host-edit-ssh-fields" id="hostEditPort-${host.replace(/\\./g, '-')}" style="${hostMethod === 'push' ? 'display:none' : ''}">
                    <span class="host-edit-at">:</span>
                    <input type="text" class="host-edit-input host-edit-port" value="${hostPort}" placeholder="22">
                </span>
                <input type="hidden" class="host-edit-method-val" value="${hostMethod}">
                <button class="host-edit-confirm" onclick="event.stopPropagation();saveHostEdit('${host}')">✓</button>
                <button class="host-edit-cancel" onclick="event.stopPropagation();hideHostEdit('${host}')">✕</button>
            </div>`;
            
            // Host actions (reload, edit, remove buttons)
            const rescanBtn = hostMethod === 'push'
                ? `<button class="host-action-btn reload disabled" title="Push hosts sync automatically" disabled>↻</button>`
                : `<button class="host-action-btn reload" onclick="event.stopPropagation();rescanHost('${fullHostEntry}')" title="Rescan host">↻</button>`;
            const hostActions = `
                <div class="host-actions">
                    ${rescanBtn}
                    <button class="host-action-btn edit" onclick="event.stopPropagation();showHostEdit('${host}')" title="Edit host">✎</button>
                    <button class="host-action-btn delete" onclick="event.stopPropagation();removeHostByName('${fullHostEntry}')" title="Remove host">✕</button>
                </div>`;
            
            if (hasDisks) {
                // Normal host with disks
                const critical = disks.filter(d => d.status === 'critical').length;
                const warning = disks.filter(d => d.status === 'warning').length;
                const capacityTB = (disks.reduce((s, d) => s + (d.capacity_bytes || 0), 0) / 1e12).toFixed(1);
                
                // Find most recent scan timestamp for this host
                let lastScan = '';
                const timestamps = disks.map(d => d.timestamp).filter(Boolean).sort();
                if (timestamps.length > 0) {
                    lastScan = formatAge(timestamps[timestamps.length - 1]);
                }
                
                let badge = '<span class="host-badge ok">OK</span>';
                if (critical > 0) badge = `<span class="host-badge critical">${critical} critical</span>`;
                else if (warning > 0) badge = `<span class="host-badge warning">${warning} warning</span>`;
                
                html += `<div class="host-group" data-host="${host}">
                    <div class="host-header" onclick="this.parentElement.classList.toggle('collapsed')">
                        <div>
                            <span class="host-name-display" id="hostDisplay-${host.replace(/\\./g, '-')}">${methodBadge}${userDisplay}${host}${pushHint}</span>
                            ${hostEditForm}
                            <span id="hostBadge-${host.replace(/\\./g, '-')}">${badge}</span>
                        </div>
                        <div class="host-stats"><span>${disks.length} drives · ${capacityTB} TB${lastScan ? ` · ${lastScan}` : ''}</span><span id="hostActions-${host.replace(/\\./g, '-')}">${hostActions}</span><span class="host-toggle">▼</span></div>
                    </div>
                    <div class="host-content">
                        <table class="disk-table">
                            <colgroup>
                                <col style="width: 120px">
                                <col style="width: 60px">
                                <col style="width: 240px">
                                <col style="width: 150px">
                                <col style="width: 80px">
                                <col style="width: 80px">
                                <col style="width: 60px">
                                <col style="width: 60px">
                                <col style="width: 60px">
                                <col style="width: 100px">
                                <col>
                            </colgroup>
                            <thead><tr>
                                <th class="sortable" onclick="sortDisks('device')">Device <span class="sort-icon">⇅</span></th>
                                <th class="sortable" onclick="sortDisks('type')">Type <span class="sort-icon">⇅</span></th>
                                <th class="sortable" onclick="sortDisks('model')">Model <span class="sort-icon">⇅</span></th>
                                <th class="sortable" onclick="sortDisks('serial')">Serial <span class="sort-icon">⇅</span></th>
                                <th class="sortable" onclick="sortDisks('size')">Size <span class="sort-icon">⇅</span></th>
                                <th class="sortable" onclick="sortDisks('hours')">Hours <span class="sort-icon">⇅</span></th>
                                <th class="sortable" onclick="sortDisks('temp')">${getTempSymbol()} <span class="sort-icon">⇅</span></th>
                                <th class="sortable" onclick="sortDisks('since')">Since <span class="info-icon" data-tip="Time since first scan of this disk. Shows how long we have historical data.">ⓘ</span> <span class="sort-icon">⇅</span></th>
                                <th class="sortable" onclick="sortDisks('last')">Last <span class="info-icon" data-tip="Time since last scan. Shows how current the data is.">ⓘ</span> <span class="sort-icon">⇅</span></th>
                                <th class="sortable" onclick="sortDisks('status')">Status <span class="sort-icon">⇅</span></th>
                                <th>Issues</th>
                            </tr></thead>
                            <tbody>${sortedDisks(disks).map(d => renderDisk(d)).join('')}</tbody>
                        </table>
                    </div>
                </div>`;
            } else {
                // Host without disks - show status
                const statusLabels = {
                    'pending': { badge: 'pending', text: 'Pending' },
                    'offline': { badge: 'offline', text: 'Offline' },
                    'auth_failed': { badge: 'offline', text: 'Auth failed' },
                    'timeout': { badge: 'offline', text: 'Timeout' },
                    'no_smartctl': { badge: 'warning', text: 'No smartctl' },
                    'no_disks': { badge: 'warning', text: 'No disks' },
                    'error': { badge: 'offline', text: 'Error' },
                };
                const statusInfo = statusLabels[status.status] || { badge: 'offline', text: status.status || 'Unknown' };
                const badge = `<span class="host-badge ${statusInfo.badge}">${statusInfo.text}</span>`;
                
                // Format last attempt time
                const lastAttempt = status.last_attempt ? formatAge(status.last_attempt) : '';
                
                const message = status.message || '';
                const statusText = message + (lastAttempt ? ` · ${lastAttempt}` : '');
                
                html += `<div class="host-group host-error" data-host="${host}">
                    <div class="host-header">
                        <div>
                            <span class="host-name-display" id="hostDisplay-${host.replace(/\\./g, '-')}">${methodBadge}${userDisplay}${host}${pushHint}</span>
                            ${hostEditForm}
                            <span id="hostBadge-${host.replace(/\\./g, '-')}">${badge}</span>
                        </div>
                        <div class="host-stats"><span>${statusText || 'Never scanned'}</span><span id="hostActions-${host.replace(/\\./g, '-')}">${hostActions}</span></div>
                    </div>
                </div>`;
            }
        }
        
        // Pending push hosts (unknown hosts that attempted to push)
        const pendingHosts = Object.entries(pushAttempts).filter(([ip, info]) => info.reason === 'unknown');
        if (pendingHosts.length > 0) {
            html += `<div class="pending-hosts-section">
                <div class="pending-hosts-header">Pending Approval</div>`;
            for (const [ip, info] of pendingHosts) {
                // Format last attempt time
                const ago = info.last_attempt ? formatAge(info.last_attempt) : '';
                html += `<div class="pending-host-row">
                    <div class="pending-host-info">
                        <span class="host-method-badge push">push</span>
                        <span class="pending-host-ip">${ip}</span>
                        <span class="pending-host-meta">${info.attempts}× · ${ago}</span>
                    </div>
                    <div class="pending-host-actions">
                        <button class="pending-btn accept" onclick="approvePushHost('${ip}', 'accept')">Accept</button>
                        <button class="pending-btn dismiss" onclick="approvePushHost('${ip}', 'dismiss')">Dismiss</button>
                    </div>
                </div>`;
            }
            html += `</div>`;
        }
        
        document.getElementById('content').innerHTML = html || '<div class="loading">No data available</div>';

        // Restore expanded state
        expandedDetails.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('visible');
        });
        expandedSections.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('visible');
        });

        applyFilters();
    }
    
    function renderDisk(d) {
        const typeClass = (d.type || '').toLowerCase();
        const statusDot = d.smart_status === 'PASSED' ? 'ok' : 'fail';
        const capacity = d.capacity_bytes >= 1e12 ? (d.capacity_bytes / 1e12).toFixed(1) + 'TB' : (d.capacity_bytes / 1e9).toFixed(0) + 'GB';
        const diskId = d.disk_id || d.serial;
        const eid = diskId.replace(/[\"' ]/g, '_');
        const attrs = d.smart_attributes || {};
        const hist = historyCache[diskId] || {};

        // Hours & temp for main table row
        let hours = parseInt(attrs.Power_On_Hours || attrs.Power_On_Hours_and_Msec || 0);
        const hoursFmt = fmtHours(hours);
        let tempRaw = getTemp(attrs);
        let temp = formatTemp(tempRaw);
        const trend = data.trends[diskId]?.delta > 0 ? '<span class="trend">▲</span>' : '';

        // Calculate data availability (time since first reading)
        const hMeta = hist || {};
        const firstReading = hMeta._first || '';
        const dataAgeMs = firstReading ? (new Date() - new Date(firstReading)) : 0;
        const dataDays = dataAgeMs / 86400000;
        const dataCoversFilter = dataDays >= deltaRangeDays || deltaRangeDays >= 36500;
        
        // Since cell - show when data started, highlight if filter exceeds data
        let sinceText = '-';
        let sinceClass = '';
        let sinceTooltip = '';
        if (firstReading) {
            sinceText = formatAge(firstReading, true);
            
            if (!dataCoversFilter) {
                sinceClass = 'since-incomplete';
                const filterStr = deltaRangeDays < 1 ? Math.round(deltaRangeDays * 24) + ' hours' : Math.round(deltaRangeDays) + ' days';
                sinceTooltip = `Only ${sinceText} of data, filter requests ${filterStr}`;
            }
        }

        // Last cell - show time since last scan
        const lastText = formatAge(d.timestamp, true);

        // Issues - already filtered by backend based on delta
        let issues = '';
        if (d.issues && d.issues.length > 0) {
            for (const issue of d.issues) {
                issues += `<span class="issue ${issue.level}">${issue.text}</span>`;
            }
        }

        // Determine health attrs for this disk type
        const diskType = d.type || 'HDD';
        const isNVMe = diskType === 'NVMe';
        const healthDefs = isNVMe ? HEALTH_ATTRS.nvme : HEALTH_ATTRS.ata;
        const healthKeys = new Set(healthDefs.map(a => a.key));
        TEMP_KEYS.forEach(k => healthKeys.add(k));

        // Sidebar
        const firmware = d.firmware || attrs.Firmware_Version || '';
        const powerCycles = attrs.Power_Cycle_Count || attrs.Power_Cycles || '-';
        const rpm = d.rpm;
        const sectorSize = d.sector_size;
        let sbHtml = '';
        if (d.wwn) sbHtml += `<div class="sidebar-item"><div class="sb-label">WWN</div><div class="sb-value">${d.wwn}</div></div>`;
        if (firmware) sbHtml += `<div class="sidebar-item"><div class="sb-label">Firmware</div><div class="sb-value">${firmware}</div></div>`;
        sbHtml += `<div class="sidebar-item"><div class="sb-label">Power Cycles</div><div class="sb-value">${powerCycles}</div></div>`;
        sbHtml += `<div class="sidebar-item"><div class="sb-label">Power On</div><div class="sb-value">${hours.toLocaleString()}h</div><div class="sb-sub">${fmtDuration(hours)}</div></div>`;
        if (rpm != null && !isNVMe) sbHtml += `<div class="sidebar-item"><div class="sb-label">RPM</div><div class="sb-value">${rpm > 0 ? rpm.toLocaleString() : 'SSD'}</div></div>`;
        if (sectorSize) sbHtml += `<div class="sidebar-item"><div class="sb-label">Sector Size</div><div class="sb-value">${sectorSize}B</div></div>`;

        // History footer info
        const nReadings = hMeta._readings || 0;
        const first = hMeta._first || '';
        const last = hMeta._last || '';
        let spanText = '';
        if (first && last && first !== last) {
            const d1 = new Date(first), d2 = new Date(last);
            const diffDays = Math.round((d2 - d1) / 86400000);
            spanText = diffDays > 0 ? `${nReadings} readings · ${diffDays}d` : `${nReadings} readings`;
        } else if (nReadings) {
            spanText = `${nReadings} readings`;
        }
        if (spanText) sbHtml += `<div class="sidebar-item"><div class="sb-label">History</div><div class="sb-sub">${spanText}</div></div>`;

        // Health attribute rows
        let healthRows = '';
        for (const attrDef of healthDefs) {
            healthRows += renderAttrRow(attrDef, attrs, hist, diskType, !isNVMe, dataCoversFilter, dataAgeMs);
        }

        // Secondary attributes
        const skipKeys = new Set([...healthKeys, ...KEY_METRIC_ATTRS, 'Firmware_Version']);
        const secondaryAttrs = Object.keys(attrs).filter(k => !skipKeys.has(k));
        let secondaryRows = '';
        for (const key of secondaryAttrs) {
            const val = attrs[key];
            const h = hist[key] || null;
            const delta = h ? h.delta : 0;
            const points = h ? h.points : null;
            let deltaStr = '\u2014';
            if (delta > 0) { deltaStr = `+${delta}`; }
            else if (delta < 0) { deltaStr = `${delta}`; }
            // Add period suffix if data doesn't cover filter
            if (delta !== 0 && !dataCoversFilter && dataAgeMs > 0) {
                deltaStr += ` <span class="delta-period">(${formatDuration(dataAgeMs)})</span>`;
            }
            const label = key.replace(/_/g, ' ');
            const tip = ATTR_TIPS[key] || '';
            const tipAttr = tip ? ` data-tip="${tip}"` : '';
            // Format LBA/Data Unit values as human-readable bytes
            let displayVal = val;
            let valTitle = '';
            const numVal = parseInt(val);
            if (LBA_KEYS.has(key) && !isNaN(numVal) && numVal > 0) {
                const bytes = numVal * 512;
                displayVal = fmtBytes(bytes);
                valTitle = ` data-tip="${numVal.toLocaleString()} sectors"`;
            } else if (DATA_UNIT_KEYS.has(key) && !isNaN(numVal) && numVal > 0) {
                const bytes = numVal * 512000;
                displayVal = fmtBytes(bytes);
                valTitle = ` data-tip="${numVal.toLocaleString()} units"`;
            }
            secondaryRows += `<tr>
                <td><span class="attr-name"${tipAttr}>${label}</span></td>
                <td class="attr-value val-ok"${valTitle}>${displayVal}</td>
                <td class="attr-delta">${deltaStr}</td>
                <td class="spark-cell">${points ? sparkSVG(points, '#3b82f6') : ''}</td>
                <td class="attr-status"></td>
            </tr>`;
        }

        const secId = 'sec-' + eid;
        const totalAttrs = healthDefs.length + secondaryAttrs.length;
        
        // Info banner if data doesn't cover filter period
        let infoBanner = '';
        if (!dataCoversFilter && dataAgeMs > 0) {
            const filterStr = deltaRangeDays < 1 ? `${Math.round(deltaRangeDays * 24)} hours` : deltaRangeDays >= 36500 ? 'all time' : `${Math.round(deltaRangeDays)} days`;
            infoBanner = `<div class="data-coverage-info">ℹ Data available: ${sinceText} · Filter: ${filterStr}</div>`;
        }

        return `<tr class="disk-row ${d.status}" data-type="${d.type}" data-status="${d.status}" onclick="toggleDetail('${eid}')">
            <td><span class="device-name">${d.device}</span></td>
            <td><span class="type-badge ${typeClass}">${d.type}</span></td>
            <td>${d.model || '-'}</td>
            <td class="mono muted">${d.serial}</td>
            <td>${capacity}</td>
            <td class="mono">${hoursFmt}${trend}</td>
            <td>${temp !== '-' ? temp + '°' : '-'}</td>
            <td class="${sinceClass}"${sinceTooltip ? ` title="${sinceTooltip}"` : ''}>${sinceText}</td>
            <td>${lastText}</td>
            <td><span class="status-dot ${statusDot}"></span>${d.smart_status}</td>
            <td>${issues || '-'}</td>
        </tr>
        <tr class="detail-row" id="detail-${eid}">
            <td colspan="11">
                <div class="detail-panel">
                    <div class="detail-sidebar">${sbHtml}</div>
                    <div class="detail-main">
                        ${infoBanner}
                        <div class="attr-section-header">
                            <div class="attr-section-title">Health & Endurance</div>
                            ${secondaryAttrs.length > 0 ? `<button class="show-all-btn" id="btn-${secId}" onclick="event.stopPropagation(); let el=document.getElementById('${secId}'); el.classList.toggle('visible'); this.textContent=el.classList.contains('visible')?'Show less':'Show all ${totalAttrs} attributes';">Show all ${totalAttrs} attributes</button>` : ''}
                        </div>
                        <div class="detail-main-body" onclick="event.stopPropagation(); if(event.target.closest('.show-all-btn,.attr-name[data-tip],.attr-value[data-tip]'))return; let btn=document.getElementById('btn-${secId}'); if(btn) btn.click();" style="cursor:pointer;">
                        <table class="attr-table">
                            <thead><tr>
                                <th style="width:38%">Attribute</th>
                                <th class="right" style="width:12%">Value</th>
                                <th class="right" style="width:10%">\u0394</th>
                                <th style="width:25%">Trend</th>
                                <th style="width:5%"></th>
                            </tr></thead>
                            <tbody>${healthRows}</tbody>
                            ${secondaryAttrs.length > 0 ? `<tbody id="${secId}" class="secondary-attrs">${secondaryRows}</tbody>` : ''}
                        </table>
                        </div>
                        ${spanText ? `<div class="detail-footer">First scan: <span>${first}</span> · Last scan: <span>${last}</span></div>` : ''}
                    </div>
                </div>
            </td>
        </tr>`;
    }
    
    function toggleDetail(eid) {
        const target = document.getElementById('detail-' + eid);
        if (!target) return;
        const diskRow = target.previousElementSibling;
        const rowTop = diskRow.getBoundingClientRect().top;
        const isOpen = target.classList.contains('visible');
        document.querySelectorAll('.detail-row.visible').forEach(el => el.classList.remove('visible'));
        if (!isOpen) target.classList.add('visible');
        const newTop = diskRow.getBoundingClientRect().top;
        window.scrollBy(0, newTop - rowTop);
    }
    
    function filterStatus(s) {
        statusFilter = s;
        document.querySelectorAll('.stat').forEach(el => el.classList.remove('active'));
        if (s) event.target.closest('.stat').classList.add('active');
        applyFilters();
    }
    
    function applyFilters() {
        const host = document.getElementById('hostFilter').value;
        const type = document.getElementById('typeFilter').value;
        const search = document.getElementById('search').value.toLowerCase();
        
        document.querySelectorAll('.host-group').forEach(g => {
            if (host && g.dataset.host !== host) { g.style.display = 'none'; return; }
            g.style.display = '';
            let visible = 0;
            g.querySelectorAll('.disk-row').forEach(r => {
                let show = true;
                if (type && r.dataset.type !== type) show = false;
                if (statusFilter && r.dataset.status !== statusFilter) show = false;
                if (search && !r.textContent.toLowerCase().includes(search)) show = false;
                r.style.display = show ? '' : 'none';
                if (!show) document.getElementById('detail-' + r.querySelector('.mono')?.textContent)?.classList.remove('visible');
                if (show) visible++;
            });
            if (!visible && (type || statusFilter || search)) g.style.display = 'none';
        });
    }
    
    // Delta range presets mapping
    const DELTA_PRESETS = {
        '1h': 1/24,
        '24h': 1,
        '7d': 7,
        '30d': 30,
        '90d': 90,
        'all': 36500
    };
    
    function updateDeltaFromDropdown(value) {
        if (DELTA_PRESETS[value] !== undefined) {
            deltaRangeDays = DELTA_PRESETS[value];
        }
        
        // Persist to localStorage
        localStorage.setItem('deltaRangePreset', value);
        
        // Save to server config, then reload all data (backend recalculates issues/status)
        fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({delta_preset: value})
        }).then(() => {
            // Reload data - backend will recalculate issues and status based on new delta
            loadData();
        }).catch(e => console.warn('Failed to save delta range:', e));
    }
    
    function restoreDeltaRange() {
        // Try to get from settingsData (server), fall back to localStorage
        let preset = '7d';
        if (settingsData && settingsData.delta_preset) {
            preset = settingsData.delta_preset;
        } else {
            const saved = localStorage.getItem('deltaRangePreset');
            if (saved) preset = saved;
        }
        
        setDropdownValue('deltaRangeWrapper', preset);
        document.getElementById('deltaRange').value = preset;
        deltaRangeDays = DELTA_PRESETS[preset] || 7;
    }
    
    let currentSort = {field: 'device', asc: true};
    
    function sortDisks(field) {
        // Toggle direction if same field
        if (currentSort.field === field) {
            currentSort.asc = !currentSort.asc;
        } else {
            currentSort.field = field;
            currentSort.asc = true;
        }
        
        // Re-render with new sort
        renderData();
        
        // Update sort icons
        document.querySelectorAll('.sort-icon').forEach(i => i.textContent = '⇅');
        document.querySelectorAll('.sortable').forEach(th => {
            if (th.textContent.toLowerCase().includes(field)) {
                th.querySelector('.sort-icon').textContent = currentSort.asc ? '↑' : '↓';
            }
        });
    }
    
    function getSortValue(disk, field) {
        const attrs = disk.smart_attributes || {};
        switch(field) {
            case 'device':
                return disk.device || '';
            case 'type':
                const typeOrder = {'NVMe': 0, 'SSD': 1, 'HDD': 2, 'Unknown': 3};
                return typeOrder[disk.type] ?? 3;
            case 'model': return disk.model || '';
            case 'serial': return disk.serial || '';
            case 'size': return disk.capacity_bytes || 0;
            case 'hours': return parseInt(attrs.Power_On_Hours || 0);
            case 'temp': return parseInt(attrs.Temperature_Celsius || attrs.Airflow_Temperature_Cel || attrs.Temperature || 0);
            case 'since':
                const diskId = disk.disk_id || disk.serial;
                const hist = historyCache[diskId] || {};
                const first = hist._first || '';
                return first ? new Date(first).getTime() : 0;
            case 'last':
                return disk.timestamp ? new Date(disk.timestamp.replace(' ', 'T') + 'Z').getTime() : 0;
            case 'status': 
                const statusOrder = {'critical': 0, 'warning': 1, 'ok': 2};
                return statusOrder[disk.status] ?? 2;
            default: return 0;
        }
    }
    
    function sortedDisks(disks) {
        return [...disks].sort((a, b) => {
            let va = getSortValue(a, currentSort.field);
            let vb = getSortValue(b, currentSort.field);
            let cmp = 0;
            if (typeof va === 'string') cmp = va.localeCompare(vb);
            else cmp = va - vb;
            return currentSort.asc ? cmp : -cmp;
        });
    }
    
    // --- Auto-Refresh ---
    let refreshTimer = null;
    
    function startAutoRefresh() {
        if (refreshTimer) clearInterval(refreshTimer);
        const seconds = parseInt(localStorage.getItem('refreshInterval') || '60');
        if (seconds > 0) {
            refreshTimer = setInterval(loadData, seconds * 1000);
        }
    }
    
    function saveRefreshInterval() {
        const val = document.getElementById('refreshIntervalSelect').value;
        localStorage.setItem('refreshInterval', val);
        startAutoRefresh();
    }
    
    async function saveRetention() {
        const val = parseInt(document.getElementById('retentionSelect').value);
        try {
            await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({retention_days: val})
            });
        } catch (e) {
            console.error('Failed to save retention:', e);
        }
    }
    
    async function saveRateLimit() {
        const maxReq = parseInt(document.getElementById('rateLimitMax').value) || 10;
        const window = parseInt(document.getElementById('rateLimitWindow').value) || 60;
        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rate_limit: {max_requests: maxReq, window_seconds: window}})
            });
            const result = await res.json();
            if (result.success) {
                // Visual feedback
                const inputs = document.querySelectorAll('.settings-number-input');
                inputs.forEach(inp => {
                    inp.style.borderColor = 'var(--success)';
                    setTimeout(() => inp.style.borderColor = '', 1500);
                });
            }
        } catch (e) {
            console.error('Failed to save rate limit:', e);
        }
    }
    
    function toggleTokenVisibility() {
        const input = document.getElementById('pushTokenInput');
        const btn = document.getElementById('tokenVisBtn');
        const showing = input.type === 'password';
        input.type = showing ? 'text' : 'password';
        const eyeOpen = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
        const eyeOff = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
        btn.innerHTML = (showing ? eyeOff : eyeOpen) + (showing ? ' Hide' : ' Show');
    }
    
    function generateToken() {
        const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
        const arr = new Uint8Array(14);
        crypto.getRandomValues(arr);
        const token = Array.from(arr, b => chars[b % chars.length]).join('');
        const input = document.getElementById('pushTokenInput');
        input.value = token;
        input.type = 'text';
        const btn = document.getElementById('tokenVisBtn');
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg> Hide';
    }
    
    function copyToken() {
        const input = document.getElementById('pushTokenInput');
        const val = input.value;
        if (!val) return;
        navigator.clipboard.writeText(val).then(() => {
            const btn = document.getElementById('copyTokenBtn');
            const original = btn.innerHTML;
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> Copied';
            btn.style.color = 'var(--success)';
            btn.style.borderColor = 'var(--success)';
            setTimeout(() => { btn.innerHTML = original; btn.style.color = ''; btn.style.borderColor = ''; }, 1500);
        });
    }
    
    async function savePushToken() {
        const token = document.getElementById('pushTokenInput').value;
        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({push_token: token})
            });
            const result = await res.json();
            if (result.success) {
                settingsData.push_token_set = token.length > 0;
                const input = document.getElementById('pushTokenInput');
                input.style.borderColor = 'var(--success)';
                setTimeout(() => input.style.borderColor = '', 1500);
            }
        } catch (e) {
            console.error('Failed to save push token:', e);
        }
    }
    
    function toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? '' : 'dark');
        document.getElementById('themeSun').style.display = isDark ? '' : 'none';
        document.getElementById('themeMoon').style.display = isDark ? 'none' : '';
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }
    
    // --- Settings Panel ---
    
    function toggleSettings(tab = 'general') {
        const overlay = document.getElementById('settingsOverlay');
        const isOpen = overlay.classList.contains('open');
        if (!isOpen) {
            overlay.classList.add('open');
            switchSettingsTab(tab);
            loadSettings();
        } else {
            overlay.classList.remove('open');
            // Reset to narrow width when closing
            document.getElementById('settingsPanel').classList.remove('wide');
        }
    }
    
    function switchSettingsTab(tab) {
        const panel = document.getElementById('settingsPanel');
        
        // Update tab buttons
        document.querySelectorAll('.settings-tab').forEach(t => {
            t.classList.toggle('active', t.dataset.tab === tab);
        });
        
        // Update tab content
        document.getElementById('tabGeneral').classList.toggle('active', tab === 'general');
        document.getElementById('tabThresholds').classList.toggle('active', tab === 'thresholds');
        
        // Adjust panel width
        if (tab === 'thresholds') {
            panel.classList.add('wide');
            renderThresholdEditor();
        } else {
            panel.classList.remove('wide');
        }
    }
    
    async function loadSettings() {
        try {
            const res = await fetch('/api/settings');
            settingsData = await res.json();
            renderHosts();
            tempUnit = settingsData.temp_unit || 'C';
            setDropdownValue('tempUnitWrapper', tempUnit);
            setDropdownValue('refreshIntervalWrapper', localStorage.getItem('refreshInterval') || '60');
            setDropdownValue('retentionWrapper', String(settingsData.retention_days || 365));
            // Rate limit settings
            const rateLimit = settingsData.rate_limit || {max_requests: 10, window_seconds: 60};
            document.getElementById('rateLimitMax').value = rateLimit.max_requests;
            document.getElementById('rateLimitWindow').value = rateLimit.window_seconds;
            // Show placeholder based on whether token is set
            const tokenInput = document.getElementById('pushTokenInput');
            tokenInput.value = '';
            tokenInput.placeholder = settingsData.push_token_set ? '••••••••  (token set)' : 'No token set';
            updatePresetDropdown();
        } catch (e) {
            console.error('Failed to load settings:', e);
        }
    }
    
    function renderHosts() {
        const container = document.getElementById('hostsList');
        if (!container) return;
        const hosts = settingsData.hosts || [];
        const stats = settingsData.host_stats || {};
        if (hosts.length === 0) {
            container.innerHTML = '<div style="font-size:12px;color:#999;padding:4px 0">No hosts configured</div>';
            return;
        }
        container.innerHTML = hosts.map((h, i) => {
            const s = stats[h];
            let info = '<span class="host-status host-new">new</span>';
            if (s) {
                const ago = timeAgo(s.last_seen);
                info = `<span class="host-meta">${s.disk_count} disk${s.disk_count !== 1 ? 's' : ''} · ${ago}</span>`;
            }
            return `<div class="host-row"><span class="host-addr">${h}</span>${info}<button class="host-remove" onclick="removeHost(${i})" title="Remove">✕</button></div>`;
        }).join('');
    }
    
    function timeAgo(ts) {
        return formatAge(ts);
    }
    
    async function addHost() {
        const input = document.getElementById('hostInput');
        const host = input.value.trim();
        if (!host) return;
        const hosts = [...(settingsData.hosts || [])];
        if (hosts.includes(host)) { input.value = ''; return; }
        hosts.push(host);
        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({hosts})
            });
            const result = await res.json();
            if (result.success) {
                settingsData.hosts = result.hosts || hosts;
                renderHosts();
                input.value = '';
            }
        } catch (e) { console.error('Failed to add host:', e); }
    }
    
    async function removeHost(idx) {
        const hosts = [...(settingsData.hosts || [])];
        hosts.splice(idx, 1);
        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({hosts})
            });
            const result = await res.json();
            if (result.success) {
                settingsData.hosts = result.hosts || hosts;
                renderHosts();
            }
        } catch (e) { console.error('Failed to remove host:', e); }
    }
    
    async function removeHostByName(hostname) {
        const btn = event.target;
        
        // First click: show confirmation state
        if (!btn.classList.contains('confirming')) {
            btn.classList.add('confirming');
            btn.innerHTML = 'Remove?';
            btn.title = 'Click again to confirm';
            
            // Click anywhere else cancels
            const cancelHandler = (e) => {
                if (e.target !== btn) {
                    btn.classList.remove('confirming');
                    btn.innerHTML = '✕';
                    btn.title = 'Remove host';
                    document.removeEventListener('click', cancelHandler, true);
                }
            };
            setTimeout(() => document.addEventListener('click', cancelHandler, true), 0);
            return;
        }
        
        // Second click: actually remove
        btn.classList.remove('confirming');
        btn.innerHTML = '...';
        
        const hosts = (settingsData.hosts || []).filter(h => h !== hostname);
        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({hosts})
            });
            const result = await res.json();
            if (result.success) {
                settingsData.hosts = result.hosts || hosts;
                await loadData();
            }
        } catch (e) { 
            console.error('Failed to remove host:', e);
            btn.innerHTML = '✕';
        }
    }
    
    async function approvePushHost(ip, action) {
        try {
            const res = await fetch('/api/push-approve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({host: ip, action})
            });
            const result = await res.json();
            if (result.success) {
                if (action === 'accept') {
                    // Reload settings to get updated host list
                    const settingsRes = await fetch('/api/settings');
                    settingsData = await settingsRes.json();
                }
                await loadData();
            }
        } catch (e) {
            console.error('Failed to approve/dismiss host:', e);
        }
    }
    
    function showHostEdit(hostIp) {
        const id = hostIp.replace(/\\./g, '-');
        const display = document.getElementById('hostDisplay-' + id);
        const form = document.getElementById('hostEdit-' + id);
        const actions = document.getElementById('hostActions-' + id);
        const badge = document.getElementById('hostBadge-' + id);
        if (display && form) {
            display.style.display = 'none';
            form.style.display = 'inline-flex';
            if (actions) actions.style.display = 'none';
            if (badge) badge.style.display = 'none';
            form.querySelector('.host-edit-ip').focus();
        }
    }
    
    function hideHostEdit(hostIp) {
        const id = hostIp.replace(/\\./g, '-');
        const display = document.getElementById('hostDisplay-' + id);
        const form = document.getElementById('hostEdit-' + id);
        const actions = document.getElementById('hostActions-' + id);
        const badge = document.getElementById('hostBadge-' + id);
        if (display && form) {
            display.style.display = '';
            form.style.display = 'none';
            if (actions) actions.style.display = '';
            if (badge) badge.style.display = '';
        }
    }
    
    async function saveHostEdit(oldIp) {
        const id = oldIp.replace(/\\./g, '-');
        const form = document.getElementById('hostEdit-' + id);
        if (!form) return;
        
        const newMethod = form.querySelector('.host-edit-method-val').value;
        const newUser = form.querySelector('.host-edit-user').value.trim();
        const newIp = form.querySelector('.host-edit-ip').value.trim();
        const newPort = form.querySelector('.host-edit-port')?.value.trim() || '';
        
        if (!newIp) {
            hideHostEdit(oldIp);
            return;
        }
        
        // Find current entry in config
        const hosts = [...(settingsData.hosts || [])];
        const idx = hosts.findIndex(h => {
            let rest = h;
            if (h.startsWith('push:')) rest = h.slice(5);
            else if (h.startsWith('ssh:')) rest = h.slice(4);
            let ip = rest.includes('@') ? rest.split('@')[1] : rest;
            // Strip port for comparison
            ip = ip.split(':')[0];
            return ip === oldIp;
        });
        if (idx === -1) return;
        
        // Build new entry with method prefix
        let newEntry;
        if (newMethod === 'push') {
            newEntry = `push:${newIp}`;
        } else {
            if (!newUser) { form.querySelector('.host-edit-user').focus(); return; }
            newEntry = `ssh:${newUser}@${newIp}`;
            if (newPort && newPort !== '22') {
                newEntry += `:${newPort}`;
            }
        }
        
        if (newEntry === hosts[idx]) {
            hideHostEdit(oldIp);
            return; // No change
        }
        
        hosts[idx] = newEntry;
        
        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({hosts})
            });
            const result = await res.json();
            if (result.success) {
                settingsData.hosts = result.hosts || hosts;
                await loadData();
            }
        } catch (e) {
            console.error('Failed to update host:', e);
            hideHostEdit(oldIp);
        }
    }
    
    async function rescanHost(hostname) {
        const btn = event.target;
        btn.classList.add('spinning');
        
        try {
            await fetch('/api/collect', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({host: hostname})
            });
            await loadData();
        } catch (e) {
            console.error('Failed to rescan host:', e);
        } finally {
            btn.classList.remove('spinning');
        }
    }
    
    async function refreshAllHosts() {
        const btn = event.target;
        btn.classList.add('spinning');
        
        // Get filtered hosts (respects host filter), skip push hosts
        const hostFilter = document.getElementById('hostFilter').value;
        const allHosts = hostFilter ? [hostFilter] : (data.hosts || []);
        
        // Build config map for method check
        const cfgMap = {};
        (settingsData?.hosts || []).forEach(h => {
            let method = 'ssh', rest = h;
            if (h.startsWith('push:')) { method = 'push'; rest = h.slice(5); }
            else if (h.startsWith('ssh:')) { rest = h.slice(4); }
            const ip = rest.includes('@') ? rest.split('@')[1] : rest;
            cfgMap[ip] = { method, full: h };
        });
        
        const sshHosts = allHosts.filter(h => (cfgMap[h]?.method || 'ssh') === 'ssh');
        
        try {
            for (const host of sshHosts) {
                const entry = cfgMap[host]?.full || host;
                await fetch('/api/collect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({host: entry})
                });
            }
            await loadData();
        } catch (e) {
            console.error('Failed to refresh hosts:', e);
        } finally {
            btn.classList.remove('spinning');
        }
    }
    
    function showAddHostInput() {
        document.getElementById('addHostBtn').style.display = 'none';
        document.getElementById('addHostInline').style.display = 'flex';
        setAddMethod('ssh');
        document.getElementById('addHostUser').value = '';
        document.getElementById('addHostPort').value = '';
        const input = document.getElementById('addHostInput');
        input.value = '';
        input.focus();
    }
    
    function hideAddHostInput() {
        document.getElementById('addHostBtn').style.display = '';
        document.getElementById('addHostInline').style.display = 'none';
        document.getElementById('addHostUser').value = '';
        document.getElementById('addHostInput').value = '';
        document.getElementById('addHostPort').value = '';
    }
    
    function toggleAddUserField(method) {
        const sshFields = document.getElementById('addHostSshFields');
        const portField = document.getElementById('addHostPortField');
        sshFields.style.display = method === 'push' ? 'none' : '';
        portField.style.display = method === 'push' ? 'none' : '';
    }
    
    function setAddMethod(method) {
        document.getElementById('addHostMethod').value = method;
        const btns = document.querySelectorAll('#addHostMethodToggle .method-toggle-btn');
        btns.forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === method));
        toggleAddUserField(method);
    }
    
    function setEditMethod(hostIp, method) {
        const id = hostIp.replace(/\\./g, '-');
        const form = document.getElementById('hostEdit-' + id);
        if (!form) return;
        form.querySelector('.host-edit-method-val').value = method;
        const btns = form.querySelectorAll('.method-toggle-btn');
        btns.forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === method));
        const sshFields = document.getElementById('hostEditSsh-' + id);
        const portFields = document.getElementById('hostEditPort-' + id);
        if (sshFields) sshFields.style.display = method === 'push' ? 'none' : '';
        if (portFields) portFields.style.display = method === 'push' ? 'none' : '';
    }
    
    function handleAddHostKey(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            addHostFromInput();
        } else if (event.key === 'Escape') {
            hideAddHostInput();
        }
    }
    
    async function addHostFromInput() {
        const methodSelect = document.getElementById('addHostMethod');
        const userInput = document.getElementById('addHostUser');
        const hostInput = document.getElementById('addHostInput');
        const portInput = document.getElementById('addHostPort');
        const method = methodSelect.value;
        const user = userInput.value.trim();
        const ip = hostInput.value.trim();
        const port = portInput.value.trim();
        if (!ip) return;
        
        // Format: "push:host" or "ssh:user@host" or "ssh:user@host:port"
        let hostEntry;
        if (method === 'push') {
            hostEntry = `push:${ip}`;
        } else {
            if (!user) { userInput.focus(); return; }
            hostEntry = `ssh:${user}@${ip}`;
            if (port && port !== '22') {
                hostEntry += `:${port}`;
            }
        }
        
        const hosts = [...(settingsData.hosts || [])];
        // Check if host already exists
        const existingIp = hosts.find(h => {
            let rest = h;
            if (h.startsWith('push:')) rest = h.slice(5);
            else if (h.startsWith('ssh:')) rest = h.slice(4);
            // Extract just the IP/hostname (before any port)
            const hostPart = rest.includes('@') ? rest.split('@')[1] : rest;
            const existingHost = hostPart.split(':')[0];
            return existingHost === ip;
        });
        if (existingIp) { 
            hideAddHostInput();
            return; 
        }
        hosts.push(hostEntry);
        
        // Clear input immediately and show scanning state
        userInput.value = '';
        hostInput.value = '';
        const btn = document.querySelector('.add-host-confirm');
        const originalText = btn.textContent;
        btn.textContent = '...';
        btn.disabled = true;
        
        try {
            // First save the host to config
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({hosts})
            });
            const result = await res.json();
            if (result.success) {
                settingsData.hosts = result.hosts || hosts;
                
                // Only trigger SSH fetch for SSH hosts
                if (method === 'ssh') {
                    try {
                        await fetch('/api/collect', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({host: hostEntry})
                        });
                    } catch (e) {
                        console.warn('Fetch failed:', e);
                    }
                }
                
                // Refresh data to show new host
                await loadData();
                hideAddHostInput();
            }
        } catch (e) { 
            console.error('Failed to add host:', e); 
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }
    
    async function saveTempUnit() {
        const val = document.getElementById('tempUnitSelect').value;
        tempUnit = val;
        try {
            await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({temp_unit: val})
            });
            renderData(); // Re-render to show new unit
        } catch (e) { console.error('Failed to save temp unit:', e); }
    }
    
    async function setPreset(name) {
        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({threshold_preset: name})
            });
            const result = await res.json();
            if (result.success) {
                // Update settingsData immediately with new preset
                if (settingsData) settingsData.active_preset = name;
                await loadSettings();
                loadData(); // Re-classify all disks with new thresholds
            }
        } catch (e) {
            console.error('Failed to save settings:', e);
        }
    }
    
    async function changePreset(name) {
        // Immediately update UI
        document.getElementById('presetFilter').value = name;
        currentThresholdPreset = name;
        updatePresetButtons();
        
        await setPreset(name);
    }
    
    function updatePresetDropdown() {
        if (settingsData && settingsData.active_preset) {
            setDropdownValue('presetFilterWrapper', settingsData.active_preset);
            document.getElementById('presetFilter').value = settingsData.active_preset;
        }
    }
    
    // Threshold Editor
    const THRESHOLD_ATTRS = {
        ata: [
            { key: 'Reallocated_Sector_Ct', label: 'Reallocated Sectors', id: 5 },
            { key: 'Reported_Uncorrect', label: 'Reported Uncorrectable', id: 187 },
            { key: 'Command_Timeout', label: 'Command Timeout', id: 188 },
            { key: 'Current_Pending_Sector', label: 'Current Pending Sectors', id: 197 },
            { key: 'Offline_Uncorrectable', label: 'Offline Uncorrectable', id: 198 },
            { key: 'Temperature_Celsius', label: 'Temperature', id: 194, unit: '°C' },
        ],
        nvme: [
            { key: 'Critical_Warning', label: 'Critical Warning' },
            { key: 'Media_and_Data_Integrity_Errors', label: 'Media Errors' },
            { key: 'Available_Spare', label: 'Available Spare', unit: '%', defaultOp: '<' },
            { key: 'Percentage_Used', label: 'Percentage Used', unit: '%' },
            { key: 'Error_Information_Log_Entries', label: 'Error Log Entries' },
            { key: 'Unsafe_Shutdowns', label: 'Unsafe Shutdowns' },
            { key: 'Temperature', label: 'Temperature', unit: '°C' },
        ]
    };
    
    const PRESET_HINTS = {
        relaxed: 'Relaxed: Higher thresholds for home/lab use. Fewer false positives, alerts only on clear degradation.',
        conservative: 'Conservative: Stricter thresholds for important data. Earlier warnings for proactive replacement.',
        backblaze: 'Backblaze: Based on failure data from 300k+ drives. Balanced sensitivity, industry standard.',
        custom: 'Custom: Your own threshold values. Edit the fields below to customize.'
    };
    
    let thresholdPresets = {};
    let currentThresholdPreset = 'backblaze';
    
    function toggleThresholdEditor() {
        // Open settings panel with thresholds tab
        const overlay = document.getElementById('settingsOverlay');
        if (overlay.classList.contains('open')) {
            // Already open, just switch to thresholds tab
            switchSettingsTab('thresholds');
        } else {
            toggleSettings('thresholds');
        }
    }
    
    function renderThresholdEditor() {
        if (!settingsData) return;
        
        thresholdPresets = settingsData.all_presets || {};
        currentThresholdPreset = settingsData.active_preset || 'backblaze';
        
        // Get thresholds to display
        const current = settingsData.thresholds || {};
        
        // Render tables
        const isCustom = currentThresholdPreset === 'custom';
        renderThresholdTable('ata', current.ata || {}, isCustom);
        renderThresholdTable('nvme', current.nvme || {}, isCustom);
        
        // Update UI
        updatePresetButtons();
        updatePresetHint();
    }
    
    function renderThresholdTable(type, thresholds, editable) {
        const tbody = document.querySelector(`#${type}Thresholds tbody`);
        const attrs = THRESHOLD_ATTRS[type];
        
        const opLabels = { '>': '>', '>=': '≥', '<': '<', '<=': '≤', '-': 'off' };
        
        let html = '';
        for (const attr of attrs) {
            const warn = (thresholds.warning || {})[attr.key] || {};
            const crit = (thresholds.critical || {})[attr.key] || {};
            const defaultOp = attr.defaultOp || '>';
            const disabledClass = editable ? '' : 'disabled';
            
            const warnOp = warn.op || (warn.value !== undefined ? defaultOp : '-');
            const critOp = crit.op || (crit.value !== undefined ? defaultOp : '-');
            
            const warnSelectId = `thresholdOp-${type}-warning-${attr.key}`;
            const critSelectId = `thresholdOp-${type}-critical-${attr.key}`;
            
            const buildOptions = (selectedOp) => {
                return ['>', '>=', '<', '<=', '-'].map(op => 
                    `<div class="custom-select-option${op === selectedOp ? ' selected' : ''}" data-value="${op}">${opLabels[op]}</div>`
                ).join('');
            };
            
            html += `<tr data-attr="${attr.key}">
                <td>${attr.label}</td>
                <td>
                    <div class="threshold-input">
                        <div class="custom-select ${disabledClass}" id="${warnSelectId}" data-type="${type}" data-level="warning" data-attr="${attr.key}" data-value="${warnOp}">
                            <div class="custom-select-trigger" onclick="toggleDropdown('${warnSelectId}')">
                                <span class="custom-select-value">${opLabels[warnOp]}</span>
                                <svg class="custom-select-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                            <div class="custom-select-options">${buildOptions(warnOp)}</div>
                        </div>
                        <input type="number" min="0" value="${warn.value ?? ''}" 
                            data-type="${type}" data-level="warning" data-attr="${attr.key}" data-field="value"
                            onchange="onThresholdChange()" ${!editable || warnOp === '-' ? 'disabled' : ''}>
                        ${attr.unit ? `<span class="unit">${attr.unit}</span>` : ''}
                    </div>
                </td>
                <td>
                    <div class="threshold-input">
                        <div class="custom-select ${disabledClass}" id="${critSelectId}" data-type="${type}" data-level="critical" data-attr="${attr.key}" data-value="${critOp}">
                            <div class="custom-select-trigger" onclick="toggleDropdown('${critSelectId}')">
                                <span class="custom-select-value">${opLabels[critOp]}</span>
                                <svg class="custom-select-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                            <div class="custom-select-options">${buildOptions(critOp)}</div>
                        </div>
                        <input type="number" min="0" value="${crit.value ?? ''}" 
                            data-type="${type}" data-level="critical" data-attr="${attr.key}" data-field="value"
                            onchange="onThresholdChange()" ${!editable || critOp === '-' ? 'disabled' : ''}>
                        ${attr.unit ? `<span class="unit">${attr.unit}</span>` : ''}
                    </div>
                </td>
            </tr>`;
        }
        tbody.innerHTML = html;
        
        // Attach click handlers to threshold select options
        tbody.querySelectorAll('.custom-select-option').forEach(opt => {
            opt.addEventListener('click', function() {
                const wrapper = this.closest('.custom-select');
                if (wrapper.classList.contains('disabled')) return;
                const value = this.dataset.value;
                selectThresholdOp(wrapper.id, value);
            });
        });
    }
    
    function selectThresholdOp(wrapperId, value) {
        const wrapper = document.getElementById(wrapperId);
        if (!wrapper || wrapper.classList.contains('disabled')) return;
        
        const opLabels = { '>': '>', '>=': '≥', '<': '<', '<=': '≤', '-': 'off' };
        
        // Update selected state
        wrapper.querySelectorAll('.custom-select-option').forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.value === value);
        });
        
        // Update displayed value
        wrapper.querySelector('.custom-select-value').textContent = opLabels[value];
        wrapper.dataset.value = value;
        
        // Close dropdown
        wrapper.classList.remove('open');
        
        // Enable/disable the adjacent input
        const input = wrapper.parentElement.querySelector('input');
        if (input) {
            input.disabled = value === '-';
        }
        
        // Trigger save
        onThresholdChange();
    }
    
    function onThresholdChange() {
        // Save after short delay
        clearTimeout(window._thresholdSaveTimeout);
        window._thresholdSaveTimeout = setTimeout(saveCustomThresholds, 500);
    }
    
    function updatePresetButtons() {
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.preset === currentThresholdPreset);
        });
        document.getElementById('presetFilter').value = currentThresholdPreset;
    }
    
    function updatePresetHint() {
        document.getElementById('presetHint').textContent = PRESET_HINTS[currentThresholdPreset] || '';
        document.getElementById('copyFromRow').classList.toggle('visible', currentThresholdPreset === 'custom');
    }
    
    function copyFromPreset(name) {
        const preset = thresholdPresets[name];
        if (!preset) return;
        renderThresholdTable('ata', preset.ata || {}, true);
        renderThresholdTable('nvme', preset.nvme || {}, true);
        onThresholdChange();
    }
    
    function selectPreset(name) {
        currentThresholdPreset = name;
        document.getElementById('presetFilter').value = name;
        
        const isCustom = name === 'custom';
        
        if (isCustom) {
            // Load current values (or last custom, or copy from current preset)
            const current = settingsData.thresholds || thresholdPresets['backblaze'] || {};
            renderThresholdTable('ata', current.ata || {}, true);
            renderThresholdTable('nvme', current.nvme || {}, true);
        } else {
            // Load preset values (read-only)
            const preset = thresholdPresets[name];
            if (preset) {
                renderThresholdTable('ata', preset.ata || {}, false);
                renderThresholdTable('nvme', preset.nvme || {}, false);
            }
            // Save preset selection
            setPreset(name);
        }
        
        updatePresetButtons();
        updatePresetHint();
    }
    
    async function saveCustomThresholds() {
        // Collect all threshold values from the form
        const thresholds = { ata: { warning: {}, critical: {} }, nvme: { warning: {}, critical: {} } };
        
        document.querySelectorAll('.threshold-input .custom-select:not(.disabled)').forEach(sel => {
            const type = sel.dataset.type;
            const level = sel.dataset.level;
            const attr = sel.dataset.attr;
            const op = sel.dataset.value;
            
            if (op !== '-') {
                const input = sel.parentElement.querySelector('input');
                const value = parseInt(input.value) || 0;
                const attrDef = THRESHOLD_ATTRS[type].find(a => a.key === attr);
                
                thresholds[type][level][attr] = {
                    op: op,
                    value: value,
                    display: attrDef?.label?.toLowerCase() || attr.replace(/_/g, ' ').toLowerCase()
                };
                if (attrDef?.id) thresholds[type][level][attr].id = attrDef.id;
            }
        });
        
        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ custom_thresholds: thresholds, threshold_preset: 'custom' })
            });
            const result = await res.json();
            if (result.success) {
                settingsData.thresholds = thresholds;
                settingsData.active_preset = 'custom';
                loadData();
            }
        } catch (e) {
            console.error('Failed to save custom thresholds:', e);
        }
    }
    
    // Init
    if (localStorage.getItem('theme') === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        document.getElementById('themeSun').style.display = 'none';
        document.getElementById('themeMoon').style.display = '';
    }
    initDropdowns();
    // Load settings to get delta range and preset, then load data
    fetch('/api/settings').then(r => r.json()).then(s => {
        settingsData = s;
        restoreDeltaRange();
        updatePresetDropdown();
        loadData();
    }).catch(() => {
        restoreDeltaRange();
        loadData();
    });
    // Restore refresh interval setting and start timer
    const savedInterval = localStorage.getItem('refreshInterval') || '60';
    document.getElementById('refreshIntervalSelect').value = savedInterval;
    startAutoRefresh();
    </script>
</body>
</html>
